<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>koliteOS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            transition: background-color 0.3s ease;
            height: 100vh;
            width: 100vw;
        }

        body.theme-dark {
            background: linear-gradient(to bottom right, #1a202c, #000000);
            color: #e0e0e0;
        }
        .theme-dark .glassmorphism {
            background-color: rgba(40, 40, 40, 0.8);
            backdrop-filter: blur(30px) saturate(180%);
            -webkit-backdrop-filter: blur(30px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        .theme-dark .window-header {
            background-color: rgba(50, 50, 50, 0.8);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .theme-dark .finder-sidebar, .theme-dark .finder-path-bar {
            background-color: rgba(50, 50, 50, 0.8);
            border-color: rgba(255, 255, 255, 0.05);
        }
        .theme-dark .finder-item:hover, .theme-dark .finder-sidebar-item:hover, .theme-dark .context-menu-item:hover, .theme-dark .desktop-icon:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .theme-dark .context-menu {
            background-color: rgba(60, 60, 60, 0.9);
        }
        .theme-dark .terminal-output {
            background-color: #000;
            color: #00FF00;
            box-shadow: inset 0 0 10px rgba(0, 255, 0, 0.2);
        }
        .theme-dark .terminal-input {
            color: #00FF00;
        }
        .theme-dark .current-time,
        .theme-dark .current-date,
        .theme-dark .desktop-icon span {
            color: #e0e0e0;
        }
        .theme-dark #status-bar span,
        .theme-dark #status-bar .fa-solid {
            color: #e0e0e0;
        }


        body.theme-light {
            background: linear-gradient(to bottom right, #e2e8f0, #ffffff);
            color: #333333;
        }
        .theme-light .glassmorphism {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(30px) saturate(180%);
            -webkit-backdrop-filter: blur(30px) saturate(180%);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        .theme-light .window-header {
            background-color: rgba(240, 240, 240, 0.8);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        .theme-light .window-title {
            color: #555;
        }
        .theme-light .window-content {
            color: #333;
        }
        .theme-light .finder-sidebar, .theme-light .finder-path-bar {
            background-color: rgba(240, 240, 240, 0.8);
            border-color: rgba(0, 0, 0, 0.05);
        }
        .theme-light .finder-item:hover, .theme-light .finder-sidebar-item:hover, .theme-light .context-menu-item:hover, .theme-light .desktop-icon:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        .theme-light .context-menu {
            background-color: rgba(230, 230, 230, 0.9);
            color: #333;
        }
        .theme-light .context-menu-item {
            color: #333;
        }
        .theme-light .context-menu-separator {
            height: 1px;
            margin: 5px 0;
        }
        .theme-light .terminal-output {
            background-color: #000;
            color: #00FF00;
            box-shadow: inset 0 0 10px rgba(0, 255, 0, 0.2);
        }
        .theme-light .terminal-input {
            color: #00FF00;
        }
        .theme-light .current-time,
        .theme-light .current-date,
        .theme-light .desktop-icon span {
            color: #333333;
        }
        .theme-light #status-bar span,
        .theme-light #status-bar .fa-solid {
            color: #333333;
        }


        .dock-item {
            transition: transform 0.1s ease-out;
            will-change: transform;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            cursor: pointer;
        }
        .dock-item img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .dock-item .fa-solid, .dock-item .fa-brands {
            font-size: 2.5rem;
        }

        .dock-item.active::after {
            content: '';
            display: block;
            width: 4px;
            height: 4px;
            background-color: #007AFF;
            border-radius: 50%;
            margin-top: 4px;
        }
        .dock-item.minimized::after {
            background-color: #888;
        }

        .dock-item.pulse {
            animation: dockPulse 0.6s ease-out;
        }

        @keyframes dockPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }


        .window {
            position: absolute;
            min-width: 300px;
            min-height: 200px;
            resize: both;
            overflow: hidden;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 50;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }

        .window-header {
            cursor: grab;
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }

        .window-controls {
            display: flex;
            gap: 6px;
        }

        .window-control-btn {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            cursor: pointer;
        }

        .close-btn { background-color: #ff5f56; }
        .minimize-btn { background-color: #ffbd2e; }
        .maximize-btn { background-color: #27c93f; }

        .window-content {
            padding: 16px;
            flex-grow: 1;
            overflow-y: auto;
        }

        .context-menu {
            position: absolute;
            backdrop-filter: blur(15px) saturate(180%);
            -webkit-backdrop-filter: blur(15px) saturate(180%);
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            padding: 8px 0;
            z-index: 1000;
            display: none;
            min-width: 150px;
        }

        .context-menu-item {
            padding: 8px 15px;
            cursor: pointer;
            font-size: 0.9rem;
            display: block;
            white-space: nowrap;
            line-height: normal;
            height: auto;
        }

        .context-menu-separator {
            height: 1px;
            margin: 5px 0;
        }

        .context-menu-item.has-submenu {
            position: relative;
        }
        .context-menu-item.has-submenu::after {
            content: 'â–º';
            position: absolute;
            right: 10px;
            color: inherit;
        }
        .submenu {
            position: absolute;
            left: 100%;
            top: 0;
            display: none;
            background-color: rgba(60, 60, 60, 0.9);
            backdrop-filter: blur(15px) saturate(180%);
            -webkit-backdrop-filter: blur(15px) saturate(180%);
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            padding: 8px 0;
            min-width: 150px;
        }
        .theme-light .submenu {
            background-color: rgba(230, 230, 230, 0.9);
        }
        .context-menu-item.has-submenu:hover > .submenu {
            display: block;
        }


        .finder-sidebar {
            width: 180px;
            flex-shrink: 0;
            padding: 15px;
            border-right: 1px solid rgba(255, 255, 255, 0.05);
        }
        .finder-main-content {
            flex-grow: 1;
            padding: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-content: flex-start;
        }
        .finder-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 80px;
            cursor: pointer;
            padding: 5px;
            border-radius: 8px;
        }
        .finder-item.highlighted {
            background-color: rgba(0, 122, 255, 0.3);
            border: 1px solid rgba(0, 122, 255, 0.5);
        }
        .finder-item img {
            width: 48px;
            height: 48px;
            margin-bottom: 5px;
        }
        .finder-item span {
            font-size: 0.8rem;
            text-align: center;
            word-break: break-all;
        }
        .finder-sidebar-item {
            padding: 8px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
        }
        .finder-sidebar-item i {
            margin-right: 8px;
        }
        .finder-path-bar {
            padding: 10px 15px;
            font-size: 0.85rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .finder-path-bar span {
            cursor: pointer;
        }
        .finder-path-bar span:hover {
            text-decoration: underline;
        }
        .finder-path-bar span:last-child {
            font-weight: bold;
            text-decoration: none;
            cursor: default;
        }

        .desktop-icon {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 80px;
            padding: 5px;
            border-radius: 8px;
            cursor: pointer;
            user-select: none;
            z-index: 40;
        }
        .desktop-icon.highlighted {
            background-color: rgba(0, 122, 255, 0.3);
            border: 1px solid rgba(0, 122, 255, 0.5);
        }
        .desktop-icon:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .desktop-icon img {
            width: 48px;
            height: 48px;
            margin-bottom: 5px;
        }

        .selection-box {
            position: absolute;
            border: 1px solid #007AFF;
            background-color: rgba(0, 122, 255, 0.2);
            z-index: 99;
            pointer-events: none;
        }


        .custom-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            display: none;
        }
        .custom-modal-content {
            background-color: rgba(60, 60, 60, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
            min-width: 300px;
            max-width: 90%;
            text-align: center;
            color: #e0e0e0;
        }
        .custom-modal-content.light {
            background-color: rgba(240, 240, 240, 0.95);
            color: #333;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        .custom-modal-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        .custom-modal-buttons button {
            padding: 8px 20px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .custom-modal-buttons .confirm-btn {
            background-color: #007AFF;
            color: white;
        }
        .custom-modal-buttons .confirm-btn:hover {
            background-color: #005bb5;
        }
        .custom-modal-buttons .cancel-btn {
            background-color: #555;
            color: white;
        }
        .custom-modal-buttons .cancel-btn:hover {
            background-color: #777;
        }
        .custom-modal-input {
            width: calc(100% - 20px);
            padding: 8px 10px;
            margin-top: 15px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background-color: rgba(0, 0, 0, 0.3);
            color: #e0e0e0;
            outline: none;
        }
        .custom-modal-content.light .custom-modal-input {
            border: 1px solid rgba(0, 0, 0, 0.2);
            background-color: rgba(255, 255, 255, 0.7);
            color: #333;
        }

        .notepad-menu-bar {
            display: flex;
            background-color: rgba(50, 50, 50, 0.9);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            padding: 4px 8px;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            position: relative;
            z-index: 70;
        }
        .theme-light .notepad-menu-bar {
            background-color: rgba(240, 240, 240, 0.9);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .notepad-menu-item {
            padding: 4px 8px;
            cursor: pointer;
            position: relative;
        }
        .notepad-menu-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        .theme-light .notepad-menu-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .notepad-dropdown-content {
            display: none;
            position: absolute;
            background-color: rgba(60, 60, 60, 0.95);
            backdrop-filter: blur(15px) saturate(180%);
            -webkit-backdrop-filter: blur(15px) saturate(180%);
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.4);
            z-index: 1;
            border-radius: 8px;
            padding: 8px 0;
            top: 100%;
            left: 0;
        }
        .theme-light .notepad-dropdown-content {
            background-color: rgba(230, 230, 230, 0.95);
        }

        .notepad-dropdown-content .menu-option {
            color: #e0e0e0;
            padding: 8px 16px;
            text-decoration: none;
            display: block;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .theme-light .notepad-dropdown-content .menu-option {
            color: #333;
        }
        .notepad-dropdown-content .menu-option:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .theme-light .notepad-dropdown-content .menu-option:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        .notepad-dropdown-separator {
            height: 1px;
            background-color: rgba(255, 255, 255, 0.1);
            margin: 5px 0;
        }
        .theme-light .notepad-dropdown-separator {
            background-color: rgba(0, 0, 0, 0.1);
        }

        .notepad-tabs-container {
            display: flex;
            background-color: rgba(50, 50, 50, 0.7);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            padding: 4px 0;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .notepad-tabs-container::-webkit-scrollbar {
            display: none;
        }
        .theme-light .notepad-tabs-container {
            background-color: rgba(240, 240, 240, 0.7);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .notepad-tab {
            display: flex;
            align-items: center;
            padding: 6px 12px;
            margin: 0 2px;
            border-radius: 8px;
            cursor: pointer;
            background-color: rgba(70, 70, 70, 0.7);
            transition: background-color 0.2s ease;
            white-space: nowrap;
        }
        .theme-light .notepad-tab {
            background-color: rgba(200, 200, 0.7);
        }

        .notepad-tab.active {
            background-color: rgba(90, 90, 90, 0.9);
            font-weight: 500;
        }
        .theme-light .notepad-tab.active {
            background-color: rgba(220, 220, 220, 0.9);
        }

        .notepad-tab:hover {
            background-color: rgba(80, 80, 80, 0.8);
        }
        .theme-light .notepad-tab:hover {
            background-color: rgba(210, 210, 210, 0.8);
        }

        .notepad-tab-close-btn {
            margin-left: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            color: #ccc;
        }
        .theme-light .notepad-tab-close-btn {
            color: #666;
        }
        .notepad-tab-close-btn:hover {
            color: #fff;
        }
        .theme-light .notepad-tab-close-btn:hover {
            color: #333;
        }

        .notepad-content-area {
            flex-grow: 1;
            position: relative;
        }

        .notepad-textarea {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 16px;
            border: none;
            outline: none;
            background-color: transparent;
            color: inherit;
            resize: none;
            font-size: 1rem;
            line-height: 1.5;
            display: none;
            overflow-y: auto;
        }
        .notepad-textarea.active {
            display: block;
        }

        .office-content-editable {
            width: 100%;
            height: 100%;
            padding: 16px;
            border: none;
            outline: none;
            background-color: transparent;
            color: inherit;
            resize: none;
            font-size: 1rem;
            line-height: 1.5;
            overflow-y: auto;
            tab-index: 0;
        }

        .photo-viewer-content {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 16px;
            text-align: center;
        }
        .photo-viewer-content img {
            max-width: 100%;
            max-height: 80%;
            object-fit: contain;
            margin-bottom: 1rem;
        }


        .search-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            z-index: 1500;
            padding-top: 10vh;
            display: none;
        }

        .search-container {
            width: 90%;
            max-width: 600px;
            background-color: rgba(60, 60, 60, 0.9);
            backdrop-filter: blur(30px) saturate(180%);
            -webkit-backdrop-filter: blur(30px) saturate(180%);
            border-radius: 16px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            color: #e0e0e0;
        }
        .theme-light .search-container {
            background-color: rgba(255, 255, 255, 0.9);
            color: #333;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        }

        .search-input-field {
            width: 100%;
            padding: 12px 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background-color: rgba(0, 0, 0, 0.2);
            color: #e0e0e0;
            font-size: 1.1rem;
            outline: none;
            transition: border-color 0.2s ease;
        }
        .search-input-field:focus {
            border-color: #007AFF;
        }
        .theme-light .search-input-field {
            border: 1px solid rgba(0, 0, 0, 0.2);
            background-color: rgba(255, 255, 255, 0.7);
            color: #333;
        }

        .search-results-container {
            max-height: 300px;
            overflow-y: auto;
            border-radius: 8px;
            background-color: rgba(0, 0, 0, 0.1);
            padding: 5px;
        }
        .theme-light .search-results-container {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .search-result-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .search-result-item:hover {
            background-color: rgba(255, 255, 255, 0.15);
        }
        .theme-light .search-result-item:hover {
            background-color: rgba(0, 0, 0, 0.08);
        }

        .search-result-item i {
            margin-right: 10px;
            font-size: 1.1rem;
            color: #007AFF;
        }
        .theme-light .search-result-item i {
            color: #007AFF;
        }

        .search-result-item span {
            flex-grow: 1;
            font-size: 1rem;
        }
        .search-result-item small {
            font-size: 0.8rem;
            color: #aaa;
        }
        .theme-light .search-result-item small {
            color: #666;
        }

        .app-launcher-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 15px;
            padding: 20px;
            max-height: calc(100% - 50px);
            overflow-y: auto;
            align-content: flex-start;
        }

        .app-launcher-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            padding: 10px 5px;
            border-radius: 10px;
            transition: background-color 0.2s ease;
        }
        .app-launcher-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .theme-light .app-launcher-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .app-launcher-item i, .app-launcher-item .fa-brands {
            font-size: 3rem;
            margin-bottom: 8px;
            color: #007AFF;
        }
        .app-launcher-item span {
            font-size: 0.85rem;
            text-align: center;
            word-break: break-all;
            line-height: 1.2;
        }

        #volume-slider-container {
            position: absolute;
            top: 35px;
            right: 150px;
            width: 150px;
            padding: 10px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 110;
            display: none;
        }
        #volume-slider {
            width: 100%;
            -webkit-appearance: none;
            height: 8px;
            background: #4a5568;
            border-radius: 5px;
            outline: none;
            transition: opacity .2s;
        }
        #volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #007AFF;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 122, 255, 0.5);
        }
        #volume-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #007AFF;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 122, 255, 0.5);
        }
        #volume-percentage {
            margin-top: 5px;
            font-size: 0.8rem;
            color: #e0e0e0;
        }
        .theme-light #volume-slider {
            background: #cbd5e0;
        }
        .theme-light #volume-percentage {
            color: #333;
        }

        #notification-container {
            position: fixed;
            top: 40px;
            right: 20px;
            z-index: 1200;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 300px;
        }
        .notification-toast {
            background-color: rgba(60, 60, 60, 0.95);
            backdrop-filter: blur(15px) saturate(180%);
            -webkit-backdrop-filter: blur(15px) saturate(180%);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: flex-start;
            color: #e0e0e0;
            opacity: 0;
            transform: translateX(100%);
            animation: slideIn 0.3s forwards, fadeOut 0.3s 4.7s forwards;
        }
        .theme-light .notification-toast {
            background-color: rgba(240, 240, 240, 0.95);
            color: #333;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .notification-toast.error {
            border-left: 4px solid #ff5f56;
        }
        .notification-toast.info {
            border-left: 4px solid #007AFF;
        }
        .notification-toast.success {
            border-left: 4px solid #27c93f;
        }

        .notification-toast .icon {
            margin-right: 10px;
            font-size: 1.2rem;
        }
        .notification-toast .content {
            flex-grow: 1;
        }
        .notification-toast .title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        .notification-toast .message {
            font-size: 0.9rem;
            line-height: 1.3;
        }
        .notification-toast .close-btn {
            background: none;
            border: none;
            color: inherit;
            font-size: 1rem;
            cursor: pointer;
            margin-left: 10px;
            padding: 0;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }
        .notification-toast .close-btn:hover {
            opacity: 1;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        .excel-grid-container {
            overflow: auto;
            flex-grow: 1;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            background-color: rgba(0, 0, 0, 0.1);
        }
        .theme-light .excel-grid-container {
            border: 1px solid rgba(0, 0, 0, 0.1);
            background-color: rgba(255, 255, 255, 0.5);
        }

        .excel-table {
            border-collapse: collapse;
            width: 100%;
            min-width: fit-content;
        }
        .excel-table th, .excel-table td {
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 8px 12px;
            min-width: 80px;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
        }
        .theme-light .excel-table th, .theme-light .excel-table td {
            border: 1px solid rgba(0, 0, 0, 0.15);
        }

        .excel-table th {
            background-color: rgba(70, 70, 70, 0.8);
            font-weight: normal;
            cursor: default;
            user-select: none;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        .theme-light .excel-table th {
            background-color: rgba(220, 220, 220, 0.8);
        }

        .excel-table td {
            background-color: rgba(50, 50, 50, 0.7);
            outline: none;
            transition: background-color 0.1s ease;
        }
        .theme-light .excel-table td {
            background-color: rgba(240, 240, 240, 0.7);
        }

        .excel-table td.selected {
            background-color: rgba(0, 122, 255, 0.3);
            border: 2px solid #007AFF;
        }
        .theme-light .excel-table td.selected {
            background-color: rgba(0, 122, 255, 0.2);
            border: 2px solid #007AFF;
        }

        .excel-formula-bar {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background-color: rgba(60, 60, 60, 0.8);
            flex-shrink: 0;
        }
        .theme-light .excel-formula-bar {
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            background-color: rgba(230, 230, 230, 0.8);
        }

        .excel-formula-bar span {
            font-weight: bold;
            margin-right: 8px;
            color: #e0e0e0;
        }
        .theme-light .excel-formula-bar span {
            color: #333;
        }

        .excel-formula-input {
            flex-grow: 1;
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background-color: rgba(0, 0, 0, 0.3);
            color: #e0e0e0;
            outline: none;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
        }
        .theme-light .excel-formula-input {
            border: 1px solid rgba(0, 0, 0, 0.2);
            background-color: rgba(255, 255, 255, 0.7);
            color: #333;
        }


        .powerpoint-layout {
            display: flex;
            height: 100%;
        }

        .powerpoint-sidebar {
            width: 150px;
            flex-shrink: 0;
            padding: 10px;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            background-color: rgba(50, 50, 50, 0.7);
            overflow-y: auto;
        }
        .theme-light .powerpoint-sidebar {
            border-right: 1px solid rgba(0, 0, 0, 0.1);
            background-color: rgba(240, 240, 240, 0.7);
        }

        .powerpoint-slide-thumbnail {
            width: 100%;
            height: 80px;
            background-color: rgba(90, 90, 90, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            color: #e0e0e0;
            transition: background-color 0.2s ease, border-color 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        .theme-light .powerpoint-slide-thumbnail {
            background-color: rgba(200, 200, 200, 0.7);
            border: 1px solid rgba(0, 0, 0, 0.2);
            color: #333;
        }

        .powerpoint-slide-thumbnail.active {
            background-color: rgba(0, 122, 255, 0.5);
            border-color: #007AFF;
        }
        .theme-light .powerpoint-slide-thumbnail.active {
            background-color: rgba(0, 122, 255, 0.3);
            border-color: #007AFF;
        }

        .powerpoint-slide-thumbnail:hover {
            background-color: rgba(110, 110, 110, 0.7);
        }
        .theme-light .powerpoint-slide-thumbnail:hover {
            background-color: rgba(210, 210, 210, 0.7);
        }

        .powerpoint-slide-thumbnail span {
            position: absolute;
            top: 5px;
            left: 5px;
            font-size: 0.7rem;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.7);
        }
        .theme-light .powerpoint-slide-thumbnail span {
            color: rgba(0, 0, 0, 0.7);
        }

        .powerpoint-thumbnail-content {
            width: 100%;
            height: 100%;
            padding: 5px;
            font-size: 0.6rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: normal;
            line-height: 1.2;
            color: inherit;
        }

        .powerpoint-slide-delete-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            background-color: rgba(255, 0, 0, 0.7);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            cursor: pointer;
            z-index: 2;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .powerpoint-slide-thumbnail:hover .powerpoint-slide-delete-btn {
            opacity: 1;
        }

        .powerpoint-main-content {
            flex-grow: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .powerpoint-slide-area {
            width: 100%;
            height: 100%;
            max-width: 900px;
            max-height: 600px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            padding: 30px;
            overflow-y: auto;
            color: #333;
        }
        .theme-dark .powerpoint-slide-area {
            background-color: rgba(255, 255, 255, 0.9);
            color: #333;
        }
        .powerpoint-slide-area .office-content-editable {
            padding: 0;
        }

        .powerpoint-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 10px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background-color: rgba(50, 50, 50, 0.7);
            flex-shrink: 0;
        }
        .theme-light .powerpoint-controls {
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            background-color: rgba(240, 240, 240, 0.7);
        }

        .powerpoint-controls button {
            padding: 8px 15px;
            border-radius: 8px;
            background-color: #007AFF;
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .powerpoint-controls button:hover {
            background-color: #005bb5;
        }

        .office-ribbon-bar {
            display: flex;
            align-items: center;
            padding: 8px;
            background-color: rgba(60, 60, 60, 0.9);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            flex-wrap: wrap;
            gap: 8px;
        }
        .theme-light .office-ribbon-bar {
            background-color: rgba(230, 230, 230, 0.9);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        .office-ribbon-bar button {
            padding: 6px 10px;
            border-radius: 6px;
            background-color: rgba(0, 0, 0, 0.2);
            color: #e0e0e0;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .theme-light .office-ribbon-bar button {
            background-color: rgba(255, 255, 255, 0.7);
            color: #333;
        }
        .office-ribbon-bar button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .theme-light .office-ribbon-bar button:hover {
            background-color: rgba(0, 0, 0, 0.08);
        }

        #bootscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(to bottom right, #1a202c, #000000);
            color: #e0e0e0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            transition: opacity 1s ease-out;
        }

        .loading-circle {
            border: 8px solid rgba(255, 255, 255, 0.3);
            border-top: 8px solid #007AFF;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1.5s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .bootscreen-text {
            font-size: 2rem;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(0, 122, 255, 0.5);
        }

        .bootscreen-tagline {
            font-size: 1.2rem;
            margin-top: 10px;
            color: #aaa;
        }

        .paint-canvas {
            border: 1px solid #ccc;
            background-color: white;
            cursor: crosshair;
            touch-action: none;
        }

        .tic-tac-toe-grid {
            display: grid;
            grid-template-columns: repeat(3, 80px);
            grid-template-rows: repeat(3, 80px);
            gap: 5px;
            border: 2px solid #333;
            background-color: #222;
        }
        .tic-tac-toe-cell {
            width: 80px;
            height: 80px;
            background-color: #444;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
            color: white;
        }
        .tic-tac-toe-cell:hover {
            background-color: #555;
        }
        .tic-tac-toe-cell.X {
            color: #007AFF;
        }
        .tic-tac-toe-cell.O {
            color: #FF5F56;
        }

        #snake-game-canvas {
            background-color: #333;
            border: 2px solid #555;
        }

        .youtube-player-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .youtube-player-input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border-radius: 6px;
            border: 1px solid #555;
            background-color: #333;
            color: #e0e0e0;
        }
        .youtube-load-btn {
            padding: 8px 12px;
            border-radius: 6px;
            background-color: #ff0000;
            color: white;
            cursor: pointer;
        }
        .youtube-iframe {
            width: 100%;
            flex-grow: 1;
            border-radius: 8px;
            overflow: hidden;
        }

        .browser-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .browser-address-bar {
            display: flex;
            margin-bottom: 10px;
            gap: 5px;
        }
        .browser-address-input {
            flex-grow: 1;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #555;
            background-color: #333;
            color: #e0e0e0;
        }
        .browser-go-btn {
            padding: 8px 12px;
            border-radius: 6px;
            background-color: #007AFF;
            color: white;
            cursor: pointer;
        }
        .browser-iframe {
            width: 100%;
            flex-grow: 1;
            border-radius: 8px;
            overflow: hidden;
        }

        #music-wave-indicator {
            display: none;
            width: 20px;
            height: 20px;
            position: relative;
            margin-left: 10px;
        }

        .music-wave-bar {
            position: absolute;
            bottom: 0;
            width: 3px;
            background-color: #007AFF;
            animation: wave 1.2s ease-in-out infinite;
        }

        .music-wave-bar:nth-child(1) { left: 0; height: 50%; animation-delay: 0s; }
        .music-wave-bar:nth-child(2) { left: 5px; height: 70%; animation-delay: 0.2s; }
        .music-wave-bar:nth-child(3) { left: 10px; height: 60%; animation-delay: 0.4s; }
        .music-wave-bar:nth-child(4) { left: 15px; height: 80%; animation-delay: 0.6s; }

        @keyframes wave {
            0%, 100% { transform: scaleY(0.5); }
            50% { transform: scaleY(1.5); }
        }

        .calculator-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            padding: 16px;
            background-color: rgba(50, 50, 50, 0.9);
            border-radius: 12px;
        }
        .calculator-display {
            grid-column: span 4;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 2.5rem;
            padding: 10px;
            border-radius: 8px;
            text-align: right;
            overflow: hidden;
            white-space: nowrap;
            margin-bottom: 8px;
        }
        .calculator-button {
            padding: 15px;
            font-size: 1.5rem;
            border-radius: 8px;
            background-color: rgba(80, 80, 80, 0.8);
            color: white;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .calculator-button:hover {
            background-color: rgba(100, 100, 100, 0.8);
        }
        .calculator-button.operator {
            background-color: #ff9500;
        }
        .calculator-button.operator:hover {
            background-color: #e08000;
        }
        .calculator-button.equals {
            background-color: #007AFF;
        }
        .calculator-button.equals:hover {
            background-color: #005bb5;
        }
        .calculator-button.clear {
            background-color: #d32f2f;
        }
        .calculator-button.clear:hover {
            background-color: #b71c1c;
        }

        .mail-layout {
            display: flex;
            height: 100%;
        }
        .mail-sidebar {
            width: 180px;
            flex-shrink: 0;
            background-color: rgba(50, 50, 50, 0.7);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 10px;
            overflow-y: auto;
        }
        .mail-sidebar-item {
            padding: 8px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .mail-sidebar-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .mail-sidebar-item.active {
            background-color: rgba(0, 122, 255, 0.3);
        }
        .mail-main-content {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
        }
        .mail-list-item {
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
        }
        .mail-list-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        .mail-compose-form input, .mail-compose-form textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background-color: rgba(0, 0, 0, 0.3);
            color: #e0e0e0;
        }
        .mail-compose-form button {
            padding: 8px 15px;
            border-radius: 8px;
            background-color: #007AFF;
            color: white;
            cursor: pointer;
        }
    </style>
</head>
<body class="theme-dark">

    <div id="bootscreen">
        <div class="loading-circle"></div>
        <div class="bootscreen-text">KoliteOS</div>
        <div class="bootscreen-tagline">The No Nonsense OS</div>
    </div>

    <div id="status-bar" class="fixed top-0 left-0 right-0 h-8 z-[100] glassmorphism flex items-center px-4">
        <div id="status-bar-app-name" class="text-sm font-semibold mr-auto cursor-pointer hover:bg-gray-700/30 rounded-md px-2 py-1 transition-colors duration-150">
            koliteOS
        </div>

        <div class="flex items-center space-x-4">
            <div id="music-wave-indicator">
                <div class="music-wave-bar"></div>
                <div class="music-wave-bar"></div>
                <div class="music-wave-bar"></div>
                <div class="music-wave-bar"></div>
            </div>
            <i id="fullscreen-toggle" class="fas fa-expand text-sm cursor-pointer hover:text-blue-400"></i>
            <i class="fas fa-battery-full text-sm cursor-pointer hover:text-green-400"></i>
            <i id="volume-button" class="fas fa-volume-up text-sm cursor-pointer hover:text-purple-400"></i>
            
            <span id="current-time" class="font-medium text-sm"></span>
            <span class="text-gray-400 text-sm">|</span>
            <span id="current-date" class="font-light text-sm"></span>
            
            <i id="search-button" class="fas fa-search text-sm cursor-pointer hover:text-blue-400 ml-4"></i>
        </div>
    </div>

    <div id="volume-slider-container" class="glassmorphism">
        <input type="range" id="volume-slider" min="0" max="100" value="50">
        <span id="volume-percentage">50%</span>
    </div>

    <div id="notification-container"></div>

    <div id="desktop" class="absolute left-0 w-full" style="top: 32px; bottom: 80px; z-index: 10;">
    </div>

    <div id="dock-container" class="glassmorphism p-3 rounded-2xl flex space-x-4 z-50 fixed bottom-10 left-1/2 -translate-x-1/2">
    </div>

    <div id="window-template" class="window glassmorphism flex flex-col" style="display: none;">
        <div class="window-header flex-shrink-0">
            <div class="window-controls mr-auto">
                <div class="window-control-btn close-btn" title="Close"></div>
                <div class="window-control-btn minimize-btn" title="Minimize"></div>
                <div class="window-control-btn maximize-btn" title="Maximize"></div>
            </div>
            <span class="window-title text-sm font-medium">Application</span>
        </div>
        <div class="window-content flex-grow">
        </div>
    </div>

    <div id="window-context-menu" class="context-menu">
        <div class="context-menu-item" data-action="close-window">Close Window</div>
        <div class="context-menu-item" data-action="minimize-window">Minimize Window</div>
        <div class="context-menu-item" data-action="maximize-window">Maximize Window</div>
    </div>

    <div id="desktop-context-menu" class="context-menu">
        <div class="context-menu-item" data-action="new-folder">New Folder</div>
        <div class="context-menu-item" data-action="get-info">Get Info</div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item has-submenu" data-action="new">New
            <div class="submenu">
                <div class="context-menu-item" data-action="new-folder-submenu">Folder</div>
                <div class="context-menu-item" data-action="new-text-document">Text Document</div>
                <div class="context-menu-item" data-action="new-word-document">Word Document</div>
                <div class="context-menu-item" data-action="new-powerpoint-presentation">PowerPoint Presentation</div>
                <div class="context-menu-item" data-action="new-excel-spreadsheet">Excel Spreadsheet</div>
            </div>
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" data-action="display-settings">Display Settings</div>
    </div>

    <div id="finder-item-context-menu" class="context-menu">
        <div class="context-menu-item" data-action="open">Open</div>
        <div class="context-menu-item" data-action="rename">Rename</div>
        <div class="context-menu-item" data-action="delete">Delete</div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" data-action="open-in-terminal">Open in Terminal</div>
    </div>

    <div id="finder-empty-context-menu" class="context-menu">
        <div class="context-menu-item" data-action="new-folder">New Folder</div>
        <div class="context-menu-item has-submenu" data-action="new">New
            <div class="submenu">
                <div class="context-menu-item" data-action="new-folder-submenu">Folder</div>
                <div class="context-menu-item" data-action="new-text-document">Text Document</div>
                <div class="context-menu-item" data-action="new-word-document">Word Document</div>
                <div class="context-menu-item" data-action="new-powerpoint-presentation">PowerPoint Presentation</div>
                <div class="context-menu-item" data-action="new-excel-spreadsheet">Excel Spreadsheet</div>
            </div>
        </div>
    </div>

    <div id="recycle-bin-item-context-menu" class="context-menu">
        <div class="context-menu-item" data-action="restore">Restore</div>
        <div class="context-menu-item" data-action="delete-permanently">Delete Permanently</div>
    </div>

    <div id="dock-item-context-menu" class="context-menu">
        <div class="context-menu-item" data-action="unpin-from-dock">Unpin from Dock</div>
        <div class="context-menu-item" data-action="pin-to-dock">Pin to Dock</div>
    </div>

    <div id="custom-modal-overlay" class="custom-modal-overlay">
        <div id="custom-modal-content" class="custom-modal-content">
            <h3 id="modal-title" class="text-lg font-semibold mb-3"></h3>
            <p id="modal-message" class="text-sm"></p>
            <input type="text" id="modal-input" class="custom-modal-input hidden">
            <div id="modal-buttons" class="custom-modal-buttons">
            </div>
        </div>
    </div>

    <div id="search-modal-overlay" class="search-modal-overlay">
        <div class="search-container">
            <input type="text" id="search-input" class="search-input-field" placeholder="Search for apps and documents...">
            <div id="search-results" class="search-results-container">
            </div>
        </div>
    </div>

    <script>
        const desktop = document.getElementById('desktop');
        const dockContainer = document.getElementById('dock-container');
        const windowTemplate = document.getElementById('window-template');
        const desktopContextMenu = document.getElementById('desktop-context-menu');
        const finderItemContextMenu = document.getElementById('finder-item-context-menu');
        const finderEmptyContextMenu = document.getElementById('finder-empty-context-menu');
        const recycleBinItemContextMenu = document.getElementById('recycle-bin-item-context-menu');
        const dockItemContextMenu = document.getElementById('dock-item-context-menu');
        const windowContextMenu = document.getElementById('window-context-menu');
        const currentTimeSpan = document.getElementById('current-time');
        const currentDateSpan = document.getElementById('current-date');
        const body = document.body;
        const statusBarAppName = document.getElementById('status-bar-app-name');
        const notificationContainer = document.getElementById('notification-container');
        const musicWaveIndicator = document.getElementById('music-wave-indicator');

        const customModalOverlay = document.getElementById('custom-modal-overlay');
        const customModalContent = document.getElementById('custom-modal-content');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalInput = document.getElementById('modal-input');
        const modalButtons = document.getElementById('modal-buttons');

        const searchButton = document.getElementById('search-button');
        const searchModalOverlay = document.getElementById('search-modal-overlay');
        const searchInput = document.getElementById('search-input');
        const searchResultsContainer = document.getElementById('search-results');

        const fullscreenToggle = document.getElementById('fullscreen-toggle');

        const volumeButton = document.getElementById('volume-button');
        const volumeSliderContainer = document.getElementById('volume-slider-container');
        const volumeSlider = document.getElementById('volume-slider');
        const volumePercentage = document.getElementById('volume-percentage');

        let selectionBox = null;
        let isSelecting = false;
        let startSelectX, startSelectY;


        let activeWindow = null;
        let windowCounter = 0;
        const openWindows = {
            'applauncher': [],
            'finder': [],
            'terminal': [],
            'settings': [],
            'notepad': [],
            'minigame': [],
            'about': [],
            'calculator': [],
            'word': [],
            'powerpoint': [],
            'excel': [],
            'photos': [],
            'recyclebin': [],
            'photopea': [],
            'vscode': [],
            'paint': [],
            'tictactoe': [],
            'snake': [],
            'youtubeplayer': [],
            'browser': [],
            'xenosai': [],
            'musicplayer': [],
            'mail': []
        };

        let currentFinderContextItem = null;
        let currentFinderWindowForContextMenu = null;
        let currentDockContextItem = null;
        let currentWindowForContextMenu = null;
        let currentRecycleBinContextItem = null;

        const desktopIconPositions = {};

        const applications = {
            'applauncher': { name: 'App Launcher', icon: 'fas fa-th-large', pinned: true },
            'finder': { name: 'Finder', icon: 'fas fa-compass', pinned: true },
            'terminal': { name: 'Terminal', icon: 'fas fa-terminal', pinned: true },
            'settings': { name: 'Settings', icon: 'fas fa-cog', pinned: true },
            'notepad': { name: 'Notepad', icon: 'fas fa-file-alt', pinned: true },
            'minigame': { name: 'Click the Dot', icon: 'fas fa-gamepad', pinned: true },
            'about': { name: 'About koliteOS', icon: 'fas fa-info-circle', pinned: true },
            'calculator': { name: 'Calculator', icon: 'fas fa-calculator', pinned: false },
            'word': { name: 'Word', icon: 'fas fa-file-word', pinned: false },
            'powerpoint': { name: 'PowerPoint', icon: 'fas fa-file-powerpoint', pinned: false },
            'excel': { name: 'Excel', icon: 'fas fa-file-excel', pinned: false },
            'photos': { name: 'Photos', icon: 'fas fa-image', pinned: false },
            'recyclebin': { name: 'Recycle Bin', icon: 'fas fa-trash-alt', pinned: false },
            'photopea': { name: 'Photopea', icon: 'fas fa-image', pinned: false },
            'vscode': { name: 'VS Code', icon: 'fas fa-code', pinned: false },
            'paint': { name: 'Paint', icon: 'fas fa-paint-brush', pinned: false },
            'tictactoe': { name: 'Tic-Tac-Toe', icon: 'fas fa-times', pinned: false },
            'snake': { name: 'Snake Game', icon: 'fas fa-snake', pinned: false },
            'youtubeplayer': { name: 'YouTube Player', icon: 'fab fa-youtube', pinned: false },
            'browser': { name: 'Browser', icon: 'fas fa-globe', pinned: false },
            'xenosai': { name: 'XenosAI', icon: 'fas fa-robot', pinned: false },
            'musicplayer': { name: 'Music Player', icon: 'fas fa-music', pinned: false },
            'mail': { name: 'Mail', icon: 'fas fa-envelope', pinned: false }
        };

        let dockedAppsState = [];

        const fileSystem = {
            'Desktop': {
                type: 'folder',
                contents: {
                    'Documents': {
                        type: 'folder',
                        contents: {
                            'My_Document.txt': { type: 'txt', content: 'This is a sample text document in koliteOS.' },
                            'Notes.txt': { type: 'txt', content: 'Remember to implement more features!' },
                            'Project_Plan.docx': { type: 'word', content: '<h1>Welcome to Word!</h1><p>Start typing your <b>document</b> here.</p>' },
                            'Presentation.pptx': { type: 'powerpoint', content: { slides: [{ content: '<h2>My Presentation</h2><p>This is a <i>sample</i> slide.</p>' }, { content: '<h3>Second Slide</h3><p>More content here.</p>' }] } },
                            'Budget.xlsx': { type: 'excel', content: { cells: { 'A1': { content: 'Item', value: 'Item', formula: null }, 'B1': { content: 'Cost', value: 'Cost', formula: null }, 'A2': { content: 'Milk', value: 'Milk', formula: null }, 'B2': { content: '3.00', value: 3.00, formula: null }, 'A3': { content: 'Bread', value: 'Bread', formula: null }, 'B3': { content: '2.50', value: 2.50, formula: null }, 'C1': { content: '', value: '', formula: '=SUM(B2:B3)' } } } }
                        }
                    },
                    'Applications': {
                        type: 'folder',
                        contents: {
                            'ReadMe.txt': { type: 'txt', content: 'Welcome to koliteOS applications folder.' }
                        }
                    },
                    'Pictures': {
                        type: 'folder',
                        contents: {
                            'Vacation.jpg': { type: 'photo', content: 'A beautiful placeholder image.' }
                        }
                    }
                }
            },
            'Downloads': {
                type: 'folder',
                contents: {
                    'setup.exe': { type: 'txt', content: 'This is a dummy executable file.' }
                }
            },
            'Documents': {
                type: 'folder',
                contents: {
                    'Important_Report.txt': { type: 'txt', content: 'This is a very important report.' }
                }
            },
            'Recycle Bin': {
                type: 'folder',
                contents: {}
            }
        };

        const wallpapers = {
            'default-dark': 'linear-gradient(to bottom right, #1a202c, #000000)',
            'default-light': 'linear-gradient(to bottom right, #e2e8f0, #ffffff)',
            'space': 'linear-gradient(to bottom right, #0F2027, #203A43, #2C5364)',
            'mountains': 'linear-gradient(to bottom right, #3A6073, #16222A)'
        };
        let currentWallpaper = 'default-dark';

        function isWallpaperDark(wallpaperKey) {
            const darkWallpapers = ['default-dark', 'space', 'mountains'];
            return darkWallpapers.includes(wallpaperKey);
        }

        function traversePath(pathArray) {
            let current = { type: 'folder', contents: fileSystem };

            for (const segment of pathArray) {
                if (current && current.type === 'folder' && current.contents && current.contents[segment]) {
                    current = current.contents[segment];
                } else {
                    return null;
                }
            }
            return current;
        }

        function getParent(pathArray) {
            if (pathArray.length === 0) return null;
            const parentPath = pathArray.slice(0, -1);
            return traversePath(parentPath);
        }

        function updateDateTime() {
            const now = new Date();
            currentTimeSpan.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            currentDateSpan.textContent = now.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        }

        const originalConsoleError = console.error;

        function showNotification(message, type = 'info', title = 'Notification') {
            const toast = document.createElement('div');
            toast.className = `notification-toast ${type} glassmorphism`;
            toast.innerHTML = `
                <div class="icon">
                    ${type === 'error' ? '<i class="fas fa-exclamation-circle text-red-500"></i>' :
                      type === 'info' ? '<i class="fas fa-info-circle text-blue-500"></i>' :
                      type === 'success' ? '<i class="fas fa-check-circle text-green-500"></i>' : ''}
                </div>
                <div class="content">
                    <div class="title">${title}</div>
                    <div class="message">${message}</div>
                </div>
                <button class="close-btn">Ã—</button>
            `;
            notificationContainer.appendChild(toast);
            toast.classList.toggle('light', body.classList.contains('theme-light'));

            const timeout = setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 5000);

            toast.querySelector('.close-btn').addEventListener('click', () => {
                clearTimeout(timeout);
                toast.remove();
            });
        }

        console.error = (...args) => {
            const errorMessage = args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : String(arg)).join(' ');
            showNotification(`Console Error: ${errorMessage}`, 'error', 'System Error');
            originalConsoleError.apply(console, args);
        };

        function showCustomAlert(message, title = 'Alert') {
            return new Promise(resolve => {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modalInput.classList.add('hidden');
                modalButtons.innerHTML = `
                    <button class="confirm-btn" id="modal-ok-btn">OK</button>
                `;
                customModalOverlay.style.display = 'flex';
                customModalContent.classList.toggle('light', body.classList.contains('theme-light'));

                document.getElementById('modal-ok-btn').onclick = () => {
                    customModalOverlay.style.display = 'none';
                    resolve(true);
                };
            });
        }

        function showCustomConfirm(message, callback, title = 'Confirm') {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalInput.classList.add('hidden');
            modalButtons.innerHTML = `
                <button class="cancel-btn" id="modal-cancel-btn">Cancel</button>
                <button class="confirm-btn" id="modal-confirm-btn">OK</button>
            `;
            customModalOverlay.style.display = 'flex';
            customModalContent.classList.toggle('light', body.classList.contains('theme-light'));

            document.getElementById('modal-confirm-btn').onclick = () => {
                customModalOverlay.style.display = 'none';
                callback(true);
            };
            document.getElementById('modal-cancel-btn').onclick = () => {
                customModalOverlay.style.display = 'none';
                callback(false);
            };
        }

        function showCustomPrompt(message, defaultValue = '', callback, title = 'Input Required') {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalInput.value = defaultValue;
            modalInput.classList.remove('hidden');
            modalButtons.innerHTML = `
                <button class="cancel-btn" id="modal-cancel-btn">Cancel</button>
                <button class="confirm-btn" id="modal-confirm-btn">OK</button>
            `;
            customModalOverlay.style.display = 'flex';
            customModalContent.classList.toggle('light', body.classList.contains('theme-light'));
            modalInput.focus();

            document.getElementById('modal-confirm-btn').onclick = () => {
                customModalOverlay.style.display = 'none';
                callback(modalInput.value);
            };
            document.getElementById('modal-cancel-btn').onclick = () => {
                customModalOverlay.style.display = 'none';
                callback(null);
            };
            modalInput.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('modal-confirm-btn').click();
                }
            };
        }

        const GRID_SIZE = 100;
        const DESKTOP_START_Y = 80;
        const DESKTOP_START_X = 20;

        function snapToGrid(x, y) {
            const snappedX = Math.round(x / GRID_SIZE) * GRID_SIZE;
            const snappedY = Math.round(y / GRID_SIZE) * GRID_SIZE;
            return { x: snappedX, y: snappedY };
        }

        function createDesktopIcon(name, type, iconSrc, initialX, initialY, onClickAction, fileType = null, itemPath = null) {
            const iconDiv = document.createElement('div');
            iconDiv.className = 'desktop-icon';
            iconDiv.draggable = true;

            let finalX = initialX;
            let finalY = initialY;
            if (desktopIconPositions[name]) {
                finalX = desktopIconPositions[name].x;
                finalY = desktopIconPositions[name].y;
            } else {
                const snapped = snapToGrid(initialX, initialY);
                finalX = snapped.x;
                finalY = snapped.y;
                desktopIconPositions[name] = { x: finalX, y: finalY };
            }

            iconDiv.style.left = `${finalX}px`;
            iconDiv.style.top = `${finalY}px`;
            iconDiv.dataset.itemName = name;
            iconDiv.dataset.itemType = type;
            iconDiv.dataset.fileType = fileType;
            if (itemPath) {
                iconDiv.dataset.itemPath = JSON.stringify(itemPath);
            }

            let iconHtml = '';
            if (iconSrc.startsWith('fas ') || iconSrc.startsWith('fab ')) {
                iconHtml = `<i class="${iconSrc} text-4xl"></i>`;
            } else {
                iconHtml = `<img src="${iconSrc}" alt="${name}">`;
            }

            iconDiv.innerHTML = `
                ${iconHtml}
                <span>${name}</span>
            `;
            desktop.appendChild(iconDiv);

            let isDraggingIcon = false;
            let offsetX, offsetY;

            iconDiv.addEventListener('mousedown', (e) => {
                if (e.button === 0) {
                    isDraggingIcon = true;
                    offsetX = e.clientX - iconDiv.getBoundingClientRect().left;
                    offsetY = e.clientY - iconDiv.getBoundingClientRect().top;
                    iconDiv.style.cursor = 'grabbing';
                    iconDiv.style.zIndex = 41;
                }
            });

            desktop.addEventListener('mousemove', (e) => {
                if (!isDraggingIcon) return;
                const rawX = e.clientX - offsetX;
                const rawY = e.clientY - offsetY;
                const snapped = snapToGrid(rawX, rawY);
                iconDiv.style.left = `${snapped.x}px`;
                iconDiv.style.top = `${snapped.y}px`;
                desktopIconPositions[name] = { x: snapped.x, y: snapped.y };
            });

            desktop.addEventListener('mouseup', () => {
                if (isDraggingIcon) {
                    isDraggingIcon = false;
                    iconDiv.style.cursor = 'pointer';
                    iconDiv.style.zIndex = 40;
                }
            });

            iconDiv.addEventListener('click', (e) => {
                if (!isDraggingIcon && onClickAction) {
                    onClickAction();
                }
            });

            iconDiv.addEventListener('dragstart', (e) => {
                e.stopPropagation();
                e.dataTransfer.setData('text/plain', JSON.stringify({
                    type: iconDiv.dataset.itemType,
                    name: iconDiv.dataset.itemName,
                    path: iconDiv.dataset.itemPath ? JSON.parse(iconDiv.dataset.itemPath) : null
                }));
                e.dataTransfer.effectAllowed = 'move';
            });

            iconDiv.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (iconDiv.dataset.itemType === 'folder') {
                    iconDiv.classList.add('highlighted');
                }
            });

            iconDiv.addEventListener('dragleave', (e) => {
                e.stopPropagation();
                iconDiv.classList.remove('highlighted');
            });

            iconDiv.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                iconDiv.classList.remove('highlighted');

                const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                const draggedItemPath = data.path;
                const draggedItemName = data.name;
                const draggedItemType = data.type;

                if (iconDiv.dataset.itemType === 'folder') {
                    const targetFolderPath = JSON.parse(iconDiv.dataset.itemPath);
                    handleFileMove(draggedItemPath, targetFolderPath, draggedItemName);
                }
            });
        }

        function initializeDesktopIcons() {
            desktop.querySelectorAll('.desktop-icon').forEach(icon => icon.remove());

            const systemIcons = [
                { name: applications['about'].name, type: 'app', icon: applications['about'].icon, appKey: 'about' },
                { name: applications['recyclebin'].name, type: 'app', icon: applications['recyclebin'].icon, appKey: 'recyclebin' }
            ];

            let currentX = DESKTOP_START_X;
            let currentY = DESKTOP_START_Y;

            systemIcons.forEach(sysIcon => {
                createDesktopIcon(
                    sysIcon.name,
                    sysIcon.type,
                    sysIcon.icon,
                    currentX,
                    currentY,
                    () => launchApp(sysIcon.appKey),
                    sysIcon.type,
                    null
                );
                currentY += GRID_SIZE;
                if (currentY + GRID_SIZE > desktop.clientHeight - GRID_SIZE) {
                    currentY = DESKTOP_START_Y;
                    currentX += GRID_SIZE;
                }
            });

            const desktopContents = fileSystem.Desktop.contents;

            const sortedDesktopItemNames = Object.keys(desktopContents).sort();

            sortedDesktopItemNames.forEach(itemName => {
                const item = desktopContents[itemName];
                let iconSrc = '';
                let onClickAction;
                let fileType = item.type;
                let itemPath = ['Desktop', itemName];

                if (systemIcons.some(sysIcon => sysIcon.name === itemName)) {
                    return;
                }

                if (item.type === 'folder') {
                    iconSrc = 'fas fa-folder';
                    onClickAction = () => {
                        const finderWindow = createWindow('finder', 'Finder', `
                            <div class="flex h-full">
                                <div class="finder-sidebar">
                                    <h3 class="text-xs text-gray-400 uppercase mb-2">Favorites</h3>
                                    <div class="finder-sidebar-item flex items-center mb-1" data-path="Desktop">
                                        <i class="fas fa-desktop text-blue-400 mr-2"></i>
                                        <span>Desktop</span>
                                    </div>
                                    <div class="finder-sidebar-item flex items-center mb-1" data-path="Documents">
                                        <i class="fas fa-folder text-blue-400 mr-2"></i>
                                        <span>Documents</span>
                                    </div>
                                    <div class="finder-sidebar-item flex items-center mb-1" data-path="Downloads">
                                        <i class="fas fa-download text-blue-400 mr-2"></i>
                                        <span>Downloads</span>
                                    </div>
                                    <div class="finder-sidebar-item flex items-center mb-1" data-path="Applications">
                                        <i class="fas fa-star text-yellow-400 mr-2"></i>
                                        <span>Applications</span>
                                    </div>
                                    <div class="finder-sidebar-item flex items-center mb-1" data-path="Recycle Bin">
                                        <i class="fas fa-trash-alt text-gray-400 mr-2"></i>
                                        <span>Recycle Bin</span>
                                    </div>
                                </div>
                                <div class="flex flex-col flex-grow">
                                    <div class="finder-path-bar"></div>
                                    <div class="finder-main-content flex-grow overflow-y-auto">
                                    </div>
                                </div>
                            </div>
                        `, 800, 500);
                        if (finderWindow) {
                            finderWindow.currentPath = ['Desktop', itemName];
                            renderFinderContent(finderWindow, finderWindow.currentPath);
                            finderWindow.querySelectorAll('.finder-sidebar-item').forEach(sidebarItem => {
                                sidebarItem.addEventListener('click', (e) => {
                                    const targetPath = e.currentTarget.dataset.path;
                                    finderWindow.currentPath = [targetPath];
                                    renderFinderContent(finderWindow, finderWindow.currentPath);
                                });
                            });
                        }
                    };
                } else {
                    switch (item.type) {
                        case 'txt':
                            iconSrc = 'fas fa-file-alt';
                            onClickAction = () => {
                                let notepadWindow = createWindow('notepad', 'Notepad', getNotepadInitialContent(), 600, 400);
                                if (notepadWindow) {
                                    setupNotepad(notepadWindow);
                                    if (notepadWindow.notepadAPI && typeof notepadWindow.notepadAPI.addTab === 'function') {
                                        notepadWindow.notepadAPI.addTab(itemName, item.content, ['Desktop']);
                                    } else {
                                        showCustomAlert('Error: Notepad API not ready after setup.', 'Application Error');
                                    }
                                }
                            };
                            break;
                        case 'word':
                            iconSrc = 'fas fa-file-word';
                            onClickAction = () => launchApp('word', itemName, item.content, ['Desktop']);
                            break;
                        case 'powerpoint':
                            iconSrc = 'fas fa-file-powerpoint';
                            onClickAction = () => launchApp('powerpoint', itemName, item.content, ['Desktop']);
                            break;
                        case 'excel':
                            iconSrc = 'fas fa-file-excel';
                            onClickAction = () => launchApp('excel', itemName, item.content, ['Desktop']);
                            break;
                        case 'photo':
                            iconSrc = 'fas fa-image';
                            onClickAction = () => launchApp('photos', itemName, item.content, ['Desktop']);
                            break;
                        default:
                            iconSrc = 'fas fa-file';
                            onClickAction = () => showCustomAlert(`Cannot open file type: ${item.type}`, 'File Type Error');
                            break;
                    }
                }

                if (iconSrc && onClickAction) {
                    createDesktopIcon(itemName, item.type, iconSrc, currentX, currentY, onClickAction, fileType, itemPath);
                    currentY += GRID_SIZE;
                    if (currentY + GRID_SIZE > desktop.clientHeight - GRID_SIZE) {
                        currentY = DESKTOP_START_Y;
                        currentX += GRID_SIZE;
                    }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', initializeDesktopIcons);


        function updateStatusBarAppName() {
            const openAppNames = new Set();
            for (const appKey in openWindows) {
                if (openWindows[appKey].some(win => win.style.display !== 'none')) {
                    openAppNames.add(applications[appKey].name);
                }
            }

            if (openAppNames.size > 0) {
                statusBarAppName.textContent = Array.from(openAppNames).join(', ');
            } else {
                statusBarAppName.textContent = 'koliteOS';
            }
        }
        updateStatusBarAppName();

        function updateFinderWindows(path) {
            openWindows['finder'].forEach(finderWin => {
                if (finderWin.style.display !== 'none' &&
                    JSON.stringify(finderWin.currentPath) === JSON.stringify(path)) {
                    renderFinderContent(finderWin, finderWin.currentPath);
                }
            });
            openWindows['recyclebin'].forEach(rbWin => {
                if (rbWin.style.display !== 'none' &&
                    JSON.stringify(rbWin.currentPath) === JSON.stringify(['Recycle Bin'])) {
                    renderFinderContent(rbWin, rbWin.currentPath);
                }
            });
        }


        function createWindow(appName, title, contentHTML, initialWidth = 600, initialHeight = 400) {
            const newWindow = windowTemplate.cloneNode(true);
            newWindow.id = `window-${appName}-${windowCounter++}`;
            newWindow.dataset.appName = appName;
            newWindow.style.display = 'flex';
            newWindow.style.left = `${50 + Math.random() * 50}px`;
            newWindow.style.top = `${50 + Math.random() * 50}px`;
            newWindow.style.width = `${initialWidth}px`;
            newWindow.style.height = `${initialHeight}px`;
            newWindow.querySelector('.window-title').textContent = title;
            newWindow.querySelector('.window-content').innerHTML = contentHTML;

            if (['notepad', 'applauncher', 'word', 'powerpoint', 'excel', 'photos', 'recyclebin', 'paint', 'tictactoe', 'snake', 'youtubeplayer', 'browser', 'xenosai', 'musicplayer', 'mail'].includes(appName)) {
                newWindow.querySelector('.window-content').classList.add('flex', 'flex-col', 'p-0');
            }

            desktop.appendChild(newWindow);
            openWindows[appName].push(newWindow);

            const dockItem = document.querySelector(`.dock-item[data-app="${appName}"]`);
            if (dockItem) {
                dockItem.classList.add('active');
                dockItem.classList.add('pulse');
                setTimeout(() => {
                    dockItem.classList.remove('pulse');
                }, 600);
            }

            const header = newWindow.querySelector('.window-header');

            newWindow.addEventListener('mousedown', (e) => {
                if (e.button === 2 && header.contains(e.target)) {
                    return;
                }
                document.querySelectorAll('.window').forEach(win => {
                    win.style.zIndex = 50;
                });
                newWindow.style.zIndex = 60;
                activeWindow = newWindow;
                updateStatusBarAppName();
            });

            let isDragging = false;
            let offsetX, offsetY;

            header.addEventListener('mousedown', (e) => {
                if (e.button === 0) {
                    isDragging = true;
                    offsetX = e.clientX - newWindow.getBoundingClientRect().left;
                    offsetY = e.clientY - newWindow.getBoundingClientRect().top;
                    header.style.cursor = 'grabbing';
                }
            });

            desktop.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                newWindow.style.left = `${e.clientX - offsetX}px`;
                newWindow.style.top = `${e.clientY - offsetY}px`;
            });

            desktop.addEventListener('mouseup', () => {
                isDragging = false;
                header.style.cursor = 'grab';
            });

            newWindow.querySelector('.close-btn').addEventListener('click', () => {
                newWindow.remove();
                openWindows[appName] = openWindows[appName].filter(win => win !== newWindow);
                
                if (openWindows[appName].length === 0) {
                    const dockItem = document.querySelector(`.dock-item[data-app="${appName}"]`);
                    if (dockItem) {
                        dockItem.classList.remove('active');
                        dockItem.classList.remove('minimized');
                    }
                    if (!applications[appName].pinned) {
                        const indexInDockedState = dockedAppsState.indexOf(appName);
                        if (indexInDockedState > -1) {
                            dockedAppsState.splice(indexInDockedState, 1);
                            renderDock();
                        }
                    }
                }
                updateStatusBarAppName();
            });

            newWindow.querySelector('.minimize-btn').addEventListener('click', () => {
                const dockItem = dockContainer.querySelector(`.dock-item[data-app="${appName}"]`);
                if (!dockItem) {
                    newWindow.style.display = 'none';
                    return;
                }

                const dockRect = dockItem.getBoundingClientRect();
                const windowRect = newWindow.getBoundingClientRect();

                const targetX = dockRect.left + (dockRect.width / 2) - (windowRect.width / 2);
                const targetY = dockRect.top + (dockRect.height / 2) - (windowRect.height / 2);

                newWindow.style.transition = 'transform 0.3s ease-in, opacity 0.3s ease-in';
                newWindow.style.transformOrigin = 'bottom center';
                newWindow.style.transform = `translate(${targetX - windowRect.left}px, ${targetY - windowRect.top}px) scale(0.1)`;
                newWindow.style.opacity = '0';

                if (dockItem) {
                    dockItem.classList.add('minimized');
                    dockItem.classList.remove('active');
                }

                newWindow.addEventListener('transitionend', function handler() {
                    if (newWindow && newWindow.parentNode) {
                        newWindow.style.display = 'none';
                        newWindow.style.transition = 'none';
                        newWindow.style.transform = 'none';
                        newWindow.style.opacity = '1';
                        newWindow.removeEventListener('transitionend', handler);
                    }
                });

                if (activeWindow === newWindow) {
                    activeWindow = null;
                }
                updateStatusBarAppName();
            });

            newWindow.querySelector('.maximize-btn').addEventListener('click', () => {
                if (newWindow.style.width === '100vw' && newWindow.style.height === 'calc(100vh - 80px)') {
                    newWindow.style.width = `${initialWidth}px`;
                    newWindow.style.height = `${initialHeight}px`;
                    newWindow.style.left = `${(window.innerWidth - initialWidth) / 2}px`;
                    newWindow.style.top = `${(window.innerHeight - initialHeight) / 2}px`;
                    newWindow.style.borderRadius = '12px';
                } else {
                    newWindow.style.width = '100vw';
                    newWindow.style.height = 'calc(100vh - 80px)';
                    newWindow.style.left = '0';
                    newWindow.style.top = '0';
                    newWindow.style.borderRadius = '0';
                }
            });

            newWindow.addEventListener('contextmenu', (e) => {
                if (e.target.closest('.window-controls') || e.target.closest('.notepad-menu-bar') || e.target.closest('.notepad-tabs-container') || e.target.closest('.terminal-input')) {
                    return;
                }
                e.preventDefault();
                e.stopPropagation();
                hideAllContextMenus();
                currentWindowForContextMenu = newWindow;
                windowContextMenu.style.left = `${e.clientX}px`;
                windowContextMenu.style.top = `${e.clientY}px`;
                windowContextMenu.style.display = 'block';
            });

            newWindow.dispatchEvent(new Event('mousedown'));
            return newWindow;
        }

        function renderFinderContent(windowElement, currentPathArray) {
            if (!windowElement) {
                console.error("renderFinderContent: windowElement is null or undefined.");
                return;
            }

            const contentDiv = windowElement.querySelector('.finder-main-content');
            const pathBar = windowElement.querySelector('.finder-path-bar');
            contentDiv.innerHTML = '';

            let currentDir = traversePath(currentPathArray);

            if (!currentDir || currentDir.type !== 'folder') {
                contentDiv.innerHTML = '<p class="text-gray-400">Error: Not a valid directory or folder is empty.</p>';
                pathBar.innerHTML = '';
                return;
            }

            pathBar.innerHTML = '';
            let tempPathSegments = [];
            pathBar.innerHTML += `<span class="path-segment px-2 py-1 rounded-md hover:bg-gray-700 transition-colors duration-150" data-path-segments='[]'>koliteOS</span>`;
            currentPathArray.forEach((segment, index) => {
                tempPathSegments.push(segment);
                pathBar.innerHTML += ` <span class="text-gray-400">/</span> <span class="path-segment px-2 py-1 rounded-md hover:bg-gray-700 transition-colors duration-150 ${index === currentPathArray.length - 1 ? 'font-bold text-white' : ''}" data-path-segments='${JSON.stringify(tempPathSegments)}'>${segment}</span>`;
            });


            pathBar.querySelectorAll('.path-segment').forEach(segmentSpan => {
                segmentSpan.addEventListener('click', (e) => {
                    if (e.currentTarget.classList.contains('font-bold')) {
                        return;
                    }
                    const targetPathSegments = JSON.parse(segmentSpan.dataset.pathSegments);
                    windowElement.currentPath = targetPathSegments;
                    renderFinderContent(windowElement, windowElement.currentPath);
                });
            });


            const itemsInDir = Object.keys(currentDir.contents);
            if (itemsInDir.length === 0) {
                contentDiv.innerHTML = '<p class="text-gray-400">This folder is empty.</p>';
            }

            const sortedItems = Object.keys(currentDir.contents).sort((a, b) => {
                const itemA = currentDir.contents[a];
                const itemB = currentDir.contents[b];
                if (itemA.type === 'folder' && itemB.type !== 'folder') return -1;
                if (itemA.type !== 'folder' && itemB.type === 'folder') return 1;
                return a.localeCompare(b);
            });


            sortedItems.forEach(itemName => {
                const item = currentDir.contents[itemName];
                const itemDiv = document.createElement('div');
                itemDiv.className = 'finder-item';
                itemDiv.draggable = true;

                let iconHtml = '';
                switch (item.type) {
                    case 'folder':
                        iconHtml = '<i class="fas fa-folder text-yellow-500 text-4xl"></i>';
                        break;
                    case 'txt':
                        iconHtml = '<i class="fas fa-file-alt text-gray-400 text-4xl"></i>';
                        break;
                    case 'word':
                        iconHtml = '<i class="fas fa-file-word text-blue-500 text-4xl"></i>';
                        break;
                    case 'powerpoint':
                        iconHtml = '<i class="fas fa-file-powerpoint text-red-500 text-4xl"></i>';
                        break;
                    case 'excel':
                        iconHtml = '<i class="fas fa-file-excel text-green-500 text-4xl"></i>';
                        break;
                    case 'photo':
                        iconHtml = '<i class="fas fa-image text-purple-500 text-4xl"></i>';
                        break;
                    default:
                        iconHtml = '<i class="fas fa-file text-gray-500 text-4xl"></i>';
                }

                itemDiv.innerHTML = `
                    ${iconHtml}
                    <span>${itemName}</span>
                `;
                itemDiv.dataset.itemName = itemName;
                itemDiv.dataset.itemType = item.type;
                itemDiv.dataset.fileType = item.type;

                itemDiv.dataset.itemPath = JSON.stringify([...currentPathArray, itemName]);
                if (item.originalPath) {
                    itemDiv.dataset.originalPath = JSON.stringify(item.originalPath);
                }


                itemDiv.addEventListener('click', () => {
                    if (item.type === 'folder') {
                        windowElement.currentPath.push(itemName);
                        renderFinderContent(windowElement, windowElement.currentPath);
                    } else {
                        const fullPath = [...currentPathArray, itemName];
                        const fileContent = traversePath(fullPath).content;
                        const fileType = item.type;

                        switch (fileType) {
                            case 'txt':
                                let notepadWindow = createWindow('notepad', 'Notepad', getNotepadInitialContent(), 600, 400);
                                if (notepadWindow) {
                                    setupNotepad(notepadWindow);
                                    if (notepadWindow.notepadAPI && typeof notepadWindow.notepadAPI.addTab === 'function') {
                                        notepadWindow.notepadAPI.addTab(itemName, fileContent, currentPathArray);
                                    } else {
                                        showCustomAlert('Error: Notepad API not ready after setup.', 'Application Error');
                                    }
                                }
                                break;
                            case 'word':
                            case 'powerpoint':
                            case 'excel':
                            case 'photo':
                                launchApp(fileType, itemName, fileContent, currentPathArray);
                                break;
                            default:
                                showCustomAlert(`Cannot open file type: ${fileType}`, 'File Type Error');
                                break;
                        }
                    }
                });

                itemDiv.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    hideAllContextMenus();
                    
                    if (currentPathArray[0] === 'Recycle Bin') {
                        currentRecycleBinContextItem = itemDiv;
                        recycleBinItemContextMenu.style.left = `${e.clientX}px`;
                        recycleBinItemContextMenu.style.top = `${e.clientY}px`;
                        recycleBinItemContextMenu.style.display = 'block';
                    } else {
                        currentFinderContextItem = itemDiv;
                        finderItemContextMenu.style.left = `${e.clientX}px`;
                        finderItemContextMenu.style.top = `${e.clientY}px`;
                        finderItemContextMenu.style.display = 'block';
                    }
                });

                itemDiv.addEventListener('dragstart', (e) => {
                    e.stopPropagation();
                    e.dataTransfer.setData('text/plain', JSON.stringify({
                        type: itemDiv.dataset.itemType,
                        name: itemDiv.dataset.itemName,
                        path: JSON.parse(itemDiv.dataset.itemPath)
                    }));
                    e.dataTransfer.effectAllowed = 'move';
                });

                itemDiv.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (itemDiv.dataset.itemType === 'folder') {
                        itemDiv.classList.add('highlighted');
                    }
                });

                itemDiv.addEventListener('dragleave', (e) => {
                    e.stopPropagation();
                    itemDiv.classList.remove('highlighted');
                });

                itemDiv.addEventListener('drop', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    itemDiv.classList.remove('highlighted');

                    const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                    const draggedItemPath = data.path;
                    const draggedItemName = data.name;

                    if (itemDiv.dataset.itemType === 'folder') {
                        const targetFolderPath = JSON.parse(itemDiv.dataset.itemPath);
                        handleFileMove(draggedItemPath, targetFolderPath, draggedItemName);
                    }
                });

                contentDiv.appendChild(itemDiv);
            });
            contentDiv.addEventListener('contextmenu', (e) => {
                if (e.target === contentDiv) {
                    e.preventDefault();
                    e.stopPropagation();
                    hideAllContextMenus();
                    finderEmptyContextMenu.style.left = `${e.clientX}px`;
                    finderEmptyContextMenu.style.top = `${e.clientY}px`;
                    finderEmptyContextMenu.style.display = 'block';
                    currentFinderWindowForContextMenu = windowElement;
                }
            });

            contentDiv.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                contentDiv.classList.add('highlighted');
            });

            contentDiv.addEventListener('dragleave', (e) => {
                e.stopPropagation();
                contentDiv.classList.remove('highlighted');
            });

            contentDiv.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                contentDiv.classList.remove('highlighted');

                const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                const draggedItemPath = data.path;
                const draggedItemName = data.name;

                handleFileMove(draggedItemPath, currentPathArray, draggedItemName);
            });
        }

        function handleFileMove(sourcePath, destinationPath, itemName) {
            const { item: srcItem, parent: srcParent, name: srcName } = getItemAndParent(sourcePath);
            const destParent = traversePath(destinationPath);

            if (!srcItem || !srcParent || srcParent.type !== 'folder') {
                showCustomAlert(`Error: Source item not found or invalid: ${sourcePath.join('/')}`, 'File Move Error');
                return;
            }
            if (!destParent || destParent.type !== 'folder') {
                showCustomAlert(`Error: Destination is not a valid folder: ${destinationPath.join('/')}`, 'File Move Error');
                return;
            }
            if (destParent.contents[itemName]) {
                showCustomAlert(`Error: An item named '${itemName}' already exists in the destination.`, 'File Move Error');
                return;
            }
            if (sourcePath.join('/') === destinationPath.join('/')) {
                return;
            }

            delete srcParent.contents[srcName];
            destParent.contents[itemName] = srcItem;

            showCustomAlert(`Moved '${itemName}' to '${destinationPath.join('/')}'.`, 'File Moved');
            updateFinderWindows(sourcePath.slice(0, -1));
            updateFinderWindows(destinationPath);
            initializeDesktopIcons();
        }

        function setupTerminal(windowElement) {
            const outputDiv = windowElement.querySelector('.terminal-output');
            const inputField = windowElement.querySelector('.terminal-input');
            let currentTerminalPath = ['Desktop'];

            const appendOutput = (text) => {
                const p = document.createElement('p');
                p.textContent = text;
                outputDiv.appendChild(p);
                outputDiv.scrollTop = outputDiv.scrollHeight;
            };

            const getCurrentPathString = () => {
                return '~/' + currentTerminalPath.join('/');
            };

            function resolvePath(pathString) {
                const parts = pathString.split('/').filter(p => p);
                let resolved = [...currentTerminalPath];
                if (pathString.startsWith('/')) {
                    resolved = [];
                }

                for (const part of parts) {
                    if (part === '..') {
                        if (resolved.length > 0) {
                            resolved.pop();
                        }
                    } else if (part !== '.') {
                        resolved.push(part);
                    }
                }
                return resolved;
            }

            function getItemAndParent(pathArray) {
                if (pathArray.length === 0) return { item: { type: 'folder', contents: fileSystem }, parent: null, name: '' };
                const parentPath = pathArray.slice(0, -1);
                const parent = traversePath(parentPath);
                const itemName = pathArray[pathArray.length - 1];
                const item = parent && parent.type === 'folder' ? parent.contents[itemName] : null;
                return { item, parent, name: itemName, parentPath: parentPath };
            }

            const executeCommand = async (command) => {
                appendOutput(`koliteOS:${getCurrentPathString()} user$ ${command}`);
                const parts = command.trim().split(/\s+/);
                const cmd = parts[0];
                const args = parts.slice(1);

                let targetItem, targetParent, targetName;
                let sourceItem, sourceParent, sourceName;

                switch (cmd) {
                    case 'help':
                        appendOutput('Available commands:');
                        appendOutput('  ls - List directory contents');
                        appendOutput('  cd [directory] - Change directory');
                        appendOutput('  echo [text] - Print text');
                        appendOutput('  cat [filename] - Display file content');
                        appendOutput('  mkdir [directory_name] - Create a new directory');
                        appendOutput('  touch [file_name] - Create a new empty file');
                        appendOutput('  rm [item_name] - Remove a file or empty directory (moves to Recycle Bin)');
                        appendOutput('  mv [source] [destination] - Move or rename files/empty folders');
                        appendOutput('  cp [source] [destination] - Copy files/empty folders');
                        appendOutput('  clear - Clear terminal output');
                        break;
                    case 'ls':
                        targetItem = traversePath(currentTerminalPath);
                        if (targetItem && targetItem.type === 'folder') {
                            if (Object.keys(targetItem.contents).length === 0) {
                                appendOutput('  (empty directory)');
                            } else {
                                for (const itemName in targetItem.contents) {
                                    const item = targetItem.contents[itemName];
                                    const typeIndicator = item.type === 'folder' ? '/' : '';
                                    appendOutput(`  ${itemName}${typeIndicator}`);
                                }
                            }
                        } else {
                            console.error('ls: cannot access current directory: No such file or directory');
                            appendOutput('ls: cannot access current directory: No such file or directory');
                        }
                        break;
                    case 'cd':
                        if (args.length === 0 || args[0] === '~') {
                            currentTerminalPath = ['Desktop'];
                            appendOutput(`Changed directory to ${getCurrentPathString()}`);
                            return;
                        }

                        const resolvedPath = resolvePath(args[0]);
                        targetItem = traversePath(resolvedPath);
                        if (targetItem && targetItem.type === 'folder') {
                            currentTerminalPath = resolvedPath;
                            appendOutput(`Changed directory to ${getCurrentPathString()}`);
                        } else {
                            console.error(`cd: no such file or directory: ${args[0]}`);
                            appendOutput(`cd: no such file or directory: ${args[0]}`);
                        }
                        break;
                    case 'echo':
                        appendOutput(args.join(' '));
                        break;
                    case 'cat':
                        if (args.length === 0) {
                            console.error('cat: missing operand');
                            appendOutput('cat: missing operand');
                            return;
                        }
                        const filePath = resolvePath(args[0]);
                        targetItem = traversePath(filePath);
                        if (targetItem && (targetItem.type === 'txt' || targetItem.type === 'word' || targetItem.type === 'powerpoint' || targetItem.type === 'excel')) {
                            appendOutput(typeof targetItem.content === 'object' ? JSON.stringify(targetItem.content, null, 2) : targetItem.content || '(empty file)');
                        } else {
                            console.error(`cat: ${args[0]}: No such file or directory or not a text-based file`);
                            appendOutput(`cat: ${args[0]}: No such file or directory or not a text-based file`);
                        }
                        break;
                    case 'mkdir':
                        if (args.length === 0) {
                            console.error('mkdir: missing operand');
                            appendOutput('mkdir: missing operand');
                            return;
                        }
                        const newFolderName = args[0];
                        targetItem = traversePath(currentTerminalPath);
                        if (targetItem && targetItem.type === 'folder') {
                            if (targetItem.contents[newFolderName]) {
                                console.error(`Folder '${newFolderName}' already exists.`);
                                appendOutput(`mkdir: cannot create directory '${newFolderName}': File exists`);
                            } else {
                                targetItem.contents[newFolderName] = { type: 'folder', contents: {} };
                                appendOutput(`Directory '${newFolderName}' created.`);
                                updateFinderWindows(currentTerminalPath);
                                if (JSON.stringify(currentTerminalPath) === JSON.stringify(['Desktop'])) {
                                    initializeDesktopIcons();
                                }
                            }
                        } else {
                            console.error('mkdir: cannot create directory: Parent directory not found');
                            appendOutput('mkdir: cannot create directory: Parent directory not found');
                        }
                        break;
                    case 'touch':
                        if (args.length === 0) {
                            console.error('touch: missing operand');
                            appendOutput('touch: missing operand');
                            return;
                        }
                        const newFileName = args[0];
                        targetItem = traversePath(currentTerminalPath);
                        if (targetItem && targetItem.type === 'folder') {
                            if (targetItem.contents[newFileName]) {
                                console.error(`File '${newFileName}' already exists.`);
                                appendOutput(`touch: '${newFileName}': File exists`);
                            } else {
                                let fileType = 'txt';
                                let initialContent = '';
                                if (newFileName.endsWith('.docx')) {
                                    fileType = 'word';
                                    initialContent = '<h1>New Document</h1><p>Start typing here...</p>';
                                } else if (newFileName.endsWith('.pptx')) {
                                    fileType = 'powerpoint';
                                    initialContent = { slides: [{ content: '<h2>New Presentation</h2><p>Click to add text</p>' }] };
                                } else if (newFileName.endsWith('.xlsx')) {
                                    fileType = 'excel';
                                    initialContent = { cells: {} };
                                } else if (newFileName.endsWith('.jpg') || newFileName.endsWith('.png')) {
                                    fileType = 'photo';
                                    initialContent = 'A new blank image file.';
                                }

                                targetItem.contents[newFileName] = { type: fileType, content: initialContent };
                                appendOutput(`File '${newFileName}' created.`);
                                updateFinderWindows(currentTerminalPath);
                                if (JSON.stringify(currentTerminalPath) === JSON.stringify(['Desktop'])) {
                                    initializeDesktopIcons();
                                }
                            }
                        } else {
                            console.error('touch: cannot create file: Parent directory not found');
                            appendOutput('touch: cannot create file: Parent directory not found');
                        }
                        break;
                    case 'rm':
                        if (args.length === 0) {
                            console.error('rm: missing operand');
                            appendOutput('rm: missing operand');
                            return;
                        }
                        const itemToRemovePath = resolvePath(args[0]);
                        const { item: rmItem, parent: rmParent, name: rmName, parentPath: rmParentPath } = getItemAndParent(itemToRemovePath);

                        if (!rmItem || !rmParent || rmParent.type !== 'folder') {
                            console.error(`rm: cannot remove '${args[0]}': No such file or directory`);
                            appendOutput(`rm: cannot remove '${args[0]}': No such file or directory`);
                            return;
                        }

                        if (rmItem.type === 'folder' && Object.keys(rmItem.contents).length > 0) {
                            console.error(`Cannot delete non-empty folder '${rmName}'.`);
                            appendOutput(`rm: cannot remove '${rmName}': Directory not empty`);
                            return;
                        }

                        const confirmResultRm = await new Promise(resolve => showCustomConfirm(`Are you sure you want to move '${rmName}' to Recycle Bin?`, resolve, 'Confirm Deletion'));
                        if (confirmResultRm) {
                            const itemToRecycle = JSON.parse(JSON.stringify(rmItem));
                            itemToRecycle.originalPath = itemToRemovePath;

                            let recycleBinName = rmName;
                            let counter = 1;
                            while (fileSystem['Recycle Bin'].contents[recycleBinName]) {
                                const nameParts = rmName.split('.');
                                const baseName = nameParts[0];
                                const extension = nameParts.length > 1 ? `.${nameParts.pop()}` : '';
                                recycleBinName = `${baseName} (${counter})${extension}`;
                                counter++;
                            }

                            fileSystem['Recycle Bin'].contents[recycleBinName] = itemToRecycle;
                            delete rmParent.contents[rmName];

                            appendOutput(`Moved '${rmName}' to Recycle Bin.`);
                            updateFinderWindows(rmParentPath);
                            if (JSON.stringify(rmParentPath) === JSON.stringify(['Desktop'])) {
                                initializeDesktopIcons();
                            }
                        } else {
                            appendOutput(`Deletion of '${rmName}' cancelled.`);
                        }
                        break;
                    case 'mv':
                        if (args.length < 2) {
                            console.error('mv: missing file operand');
                            appendOutput('mv: missing file operand');
                            return;
                        }
                        const sourcePath = resolvePath(args[0]);
                        const destPath = resolvePath(args[1]);

                        const { item: srcItem, parent: srcParent, name: srcName, parentPath: srcParentPath } = getItemAndParent(sourcePath);

                        if (!srcItem || !srcParent || srcParent.type !== 'folder') {
                            console.error(`mv: cannot stat '${args[0]}': No such file or directory`);
                            appendOutput(`mv: cannot stat '${args[0]}': No such file or directory`);
                            return;
                        }
                        if (srcItem.type === 'folder' && Object.keys(srcItem.contents).length > 0) {
                            console.error(`mv: cannot move non-empty folder '${srcName}'.`);
                            appendOutput(`mv: cannot move non-empty folder '${srcName}'.`);
                            return;
                        }

                        let finalDestPath;
                        let finalDestName;
                        let destParentPath;

                        const potentialDestDir = traversePath(destPath);
                        if (potentialDestDir && potentialDestDir.type === 'folder') {
                            finalDestPath = [...destPath, srcName];
                            finalDestName = srcName;
                            destParentPath = destPath;
                        } else {
                            finalDestPath = destPath;
                            finalDestName = destPath[destPath.length - 1];
                            destParentPath = destPath.slice(0, -1);
                        }

                        const finalDestParent = traversePath(destParentPath);

                        if (!finalDestParent || finalDestParent.type !== 'folder') {
                            console.error(`mv: cannot create regular file '${args[1]}': No such file or directory`);
                            appendOutput(`mv: cannot create regular file '${args[1]}': No such file or directory`);
                            return;
                        }
                        if (finalDestParent.contents[finalDestName] && finalDestParent.contents[finalDestName] !== srcItem) {
                            console.error(`mv: cannot move '${srcName}' to '${args[1]}': Destination file exists`);
                            appendOutput(`mv: cannot move '${srcName}' to '${args[1]}': Destination file exists`);
                            return;
                        }

                        delete srcParent.contents[srcName];
                        finalDestParent.contents[finalDestName] = srcItem;
                        appendOutput(`Moved '${srcName}' to '${finalDestPath.join('/')}'.`);
                        updateFinderWindows(srcParentPath);
                        updateFinderWindows(destParentPath);
                        if (JSON.stringify(srcParentPath) === JSON.stringify(['Desktop']) || JSON.stringify(destParentPath) === JSON.stringify(['Desktop'])) {
                            initializeDesktopIcons();
                        }
                        break;
                    case 'cp':
                        if (args.length < 2) {
                            console.error('cp: missing file operand');
                            appendOutput('cp: missing file operand');
                            return;
                        }
                        const sourceCopyPath = resolvePath(args[0]);
                        const destCopyPath = resolvePath(args[1]);

                        const { item: srcCopyItem, parent: srcCopyParent, name: srcCopyName } = getItemAndParent(sourceCopyPath);

                        if (!srcCopyItem || !srcCopyParent || srcCopyParent.type !== 'folder') {
                            console.error(`cp: cannot stat '${args[0]}': No such file or directory`);
                            appendOutput(`cp: cannot stat '${args[0]}': No such file or directory`);
                            return;
                        }
                        if (srcCopyItem.type === 'folder' && Object.keys(srcCopyItem.contents).length > 0) {
                            console.error(`cp: -r not supported for non-empty folders: ${srcCopyName}`);
                            appendOutput(`cp: -r not supported for non-empty folders: ${srcCopyName}`);
                            return;
                        }

                        let finalCopyDestPath;
                        let finalCopyDestName;
                        let destCopyParentPath;

                        const potentialCopyDestDir = traversePath(destCopyPath);
                        if (potentialCopyDestDir && potentialCopyDestDir.type === 'folder') {
                            finalCopyDestPath = [...destCopyPath, srcCopyName];
                            finalCopyDestName = srcCopyName;
                            destCopyParentPath = destCopyPath;
                        } else {
                            finalCopyDestPath = destCopyPath;
                            finalCopyDestName = destCopyPath[destCopyPath.length - 1];
                            destCopyParentPath = destCopyPath.slice(0, -1);
                        }

                        const finalCopyDestParent = traversePath(destCopyParentPath);
                        if (!finalCopyDestParent || finalCopyDestParent.type !== 'folder') {
                            console.error(`cp: cannot create regular file '${args[1]}': No such file or directory`);
                            appendOutput(`cp: cannot create regular file '${args[1]}': No such file or directory`);
                            return;
                        }
                        if (finalCopyDestParent.contents[finalCopyDestName]) {
                            console.error(`cp: cannot copy '${srcCopyName}' to '${args[1]}': Destination file exists`);
                            appendOutput(`cp: cannot copy '${srcCopyName}' to '${args[1]}': Destination file exists`);
                            return;
                        }

                        const copiedItem = JSON.parse(JSON.stringify(srcCopyItem));
                        finalCopyDestParent.contents[finalCopyDestName] = copiedItem;
                        appendOutput(`Copied '${srcCopyName}' to '${finalCopyDestPath.join('/')}'.`);
                        updateFinderWindows(destCopyParentPath);
                        if (JSON.stringify(destCopyParentPath) === JSON.stringify(['Desktop'])) {
                            initializeDesktopIcons();
                        }
                        break;
                    case 'clear':
                        outputDiv.innerHTML = '';
                        break;
                    case '':
                        break;
                    default:
                        appendOutput(`koliteOS: command not found: ${cmd}`);
                        break;
                }
            };

            inputField.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const command = inputField.value;
                    inputField.value = '';
                    executeCommand(command);
                }
            });

            windowElement.setTerminalPath = (pathArray) => {
                currentTerminalPath = pathArray;
                appendOutput(`Changed directory to ${getCurrentPathString()}`);
            };
        }


        let gameInterval;
        let gameTimer;
        let score = 0;
        let timeLeft = 30;

        function startGame(windowElement) {
            const gameArea = windowElement.querySelector('#game-area');
            const scoreDisplay = windowElement.querySelector('#game-score');
            const timerDisplay = windowElement.querySelector('#game-timer');
            const startButton = windowElement.querySelector('#game-start-btn');
            const messageDisplay = windowElement.querySelector('#game-message');

            score = 0;
            timeLeft = 30;
            scoreDisplay.textContent = score;
            timerDisplay.textContent = timeLeft;
            messageDisplay.textContent = 'Click dots to score!';
            gameArea.innerHTML = '';

            startButton.disabled = true;

            function createDot() {
                if (timeLeft <= 0) return;

                const dot = document.createElement('div');
                dot.className = 'absolute w-8 h-8 bg-red-500 rounded-full cursor-pointer transition-all duration-100 ease-out transform hover:scale-110';
                
                const gameAreaRect = gameArea.getBoundingClientRect();
                const maxX = gameAreaRect.width - 32;
                const maxY = gameAreaRect.height - 32;

                const randomX = Math.random() * maxX;
                const randomY = Math.random() * maxY;

                dot.style.left = `${randomX}px`;
                dot.style.top = `${randomY}px`;

                dot.addEventListener('click', () => {
                    score++;
                    scoreDisplay.textContent = score;
                    dot.remove();
                });
                gameArea.appendChild(dot);

                setTimeout(() => {
                    if (dot.parentNode) {
                        dot.remove();
                    }
                }, 1500);
            }

            gameInterval = setInterval(createDot, 1000);

            gameTimer = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(gameInterval);
                    clearInterval(gameTimer);
                    messageDisplay.textContent = `Game Over! Your score: ${score}`;
                    startButton.disabled = false;
                    gameArea.innerHTML = '';
                }
            }, 1000);
        }

        function getNotepadInitialContent() {
            return `
                <div class="notepad-menu-bar">
                    <div class="notepad-menu-item" id="file-menu-btn" data-menu-id="file-menu">File
                        <div class="notepad-dropdown-content">
                            <div class="menu-option" data-action="new-file">New File</div>
                            <div class="menu-option" data-action="open-file">Open File...</div>
                            <div class="menu-option" data-action="save-file">Save File</div>
                            <div class="notepad-dropdown-separator"></div>
                            <div class="menu-option" data-action="close-tab">Close Tab</div>
                        </div>
                    </div>
                    <div class="notepad-menu-item" id="view-menu-btn" data-menu-id="view-menu">View
                        <div class="notepad-dropdown-content">
                            <div class="menu-option" data-action="zoom-in">Zoom In</div>
                            <div class="menu-option" data-action="zoom-out">Zoom Out</div>
                            <div class="menu-option" data-action="reset-zoom">Reset Zoom</div>
                        </div>
                    </div>
                </div>
                <div class="notepad-tabs-container"></div>
                <div class="notepad-content-area flex-grow"></div>
            `;
        }

        function setupNotepad(windowElement) {
            windowElement.notepadTabs = [];
            windowElement.activeTabId = null;

            const tabsContainer = windowElement.querySelector('.notepad-tabs-container');
            const contentArea = windowElement.querySelector('.notepad-content-area');

            windowElement.notepadAPI = {
                addTab: addNotepadTab,
                switchTab: switchNotepadTab,
                closeTab: closeNotepadTab,
                updateFontSize: updateNotepadFontSize,
                saveFile: saveNotepadFile
            };

            function renderNotepad() {
                tabsContainer.innerHTML = '';
                contentArea.innerHTML = '';

                if (windowElement.notepadTabs.length === 0) {
                    addNotepadTab('Untitled', '', ['Desktop']);
                    return;
                }

                windowElement.notepadTabs.forEach(tab => {
                    const tabDiv = document.createElement('div');
                    tabDiv.className = `notepad-tab ${tab.id === windowElement.activeTabId ? 'active' : ''}`;
                    tabDiv.dataset.tabId = tab.id;
                    tabDiv.innerHTML = `
                        <span>${tab.name}</span>
                        <i class="fas fa-times notepad-tab-close-btn"></i>
                    `;
                    tabsContainer.appendChild(tabDiv);

                    const textarea = document.createElement('textarea');
                    textarea.id = `textarea-${tab.id}`;
                    textarea.className = `notepad-textarea ${tab.id === windowElement.activeTabId ? 'active' : ''}`;
                    textarea.value = tab.content;
                    textarea.style.fontSize = `${tab.fontSize || 16}px`;
                    textarea.addEventListener('input', (e) => {
                        const currentTab = windowElement.notepadTabs.find(t => t.id === tab.id);
                        if (currentTab) {
                            currentTab.content = e.target.value;
                        }
                    });
                    contentArea.appendChild(textarea);

                    tabDiv.addEventListener('click', (e) => {
                        if (!e.target.classList.contains('notepad-tab-close-btn')) {
                            switchNotepadTab(tab.id);
                        }
                    });

                    tabDiv.querySelector('.notepad-tab-close-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        closeNotepadTab(tab.id);
                    });
                });

                const activeTextarea = windowElement.querySelector(`#textarea-${windowElement.activeTabId}`);
                if (activeTextarea) {
                    activeTextarea.focus();
                }
            }

            function addNotepadTab(name, content, parentPath = []) {
                const newTabId = `tab-${Date.now()}`;
                windowElement.notepadTabs.push({
                    id: newTabId,
                    name: name,
                    content: content,
                    fontSize: 16,
                    parentPath: parentPath
                });
                windowElement.activeTabId = newTabId;
                renderNotepad();
            }

            function switchNotepadTab(tabId) {
                windowElement.activeTabId = tabId;
                renderNotepad();
            }

            function closeNotepadTab(tabIdToClose) {
                const tabToClose = windowElement.notepadTabs.find(t => t.id === tabIdToClose);
                if (!tabToClose) return;

                showCustomConfirm(`Are you sure you want to close '${tabToClose.name}'?`, (confirm) => {
                    if (confirm) {
                        const indexToClose = windowElement.notepadTabs.findIndex(tab => tab.id === tabIdToClose);
                        if (indexToClose > -1) {
                            windowElement.notepadTabs.splice(indexToClose, 1);

                            if (windowElement.notepadTabs.length === 0) {
                                windowElement.querySelector('.close-btn').click();
                            } else if (windowElement.activeTabId === tabIdToClose) {
                                windowElement.activeTabId = windowElement.notepadTabs[Math.max(0, indexToClose - 1)].id;
                                renderNotepad();
                            } else {
                                renderNotepad();
                            }
                        }
                    }
                }, 'Close Tab');
            }

            function updateNotepadFontSize(change) {
                const activeTab = windowElement.notepadTabs.find(t => t.id === windowElement.activeTabId);
                if (activeTab) {
                    let newSize = activeTab.fontSize + change;
                    if (newSize < 8) newSize = 8;
                    if (newSize > 72) newSize = 72;
                    activeTab.fontSize = newSize;
                    renderNotepad();
                }
            }

            function saveNotepadFile() {
                const activeTab = windowElement.notepadTabs.find(t => t.id === windowElement.activeTabId);
                if (!activeTab) {
                    showCustomAlert("No active file to save.", "Save Error");
                    return;
                }

                const fileInFs = traversePath([...activeTab.parentPath, activeTab.name]);
                if (fileInFs && (fileInFs.type === 'txt' || fileInFs.type === 'word' || fileInFs.type === 'powerpoint' || fileInFs.type === 'excel')) {
                    fileInFs.content = activeTab.content;
                    showCustomAlert(`File "${activeTab.name}" updated in current session. (Changes are not persistent across sessions)`, 'Save Successful');
                } else {
                    showCustomAlert(`Could not find file "${activeTab.name}" in file system to update.`, 'Save Error');
                }
            }

            renderNotepad();

            windowElement.querySelectorAll('.notepad-menu-item').forEach(menuItem => {
                menuItem.addEventListener('mousedown', (e) => {
                    windowElement.querySelectorAll('.notepad-dropdown-content').forEach(dropdown => {
                        if (dropdown !== menuItem.querySelector('.notepad-dropdown-content')) {
                            dropdown.style.display = 'none';
                        }
                    });

                    const dropdown = menuItem.querySelector('.notepad-dropdown-content');
                    if (dropdown) {
                        dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                    }
                });
            });

            windowElement.addEventListener('click', (e) => {
                if (!e.target.closest('.notepad-menu-bar')) {
                    windowElement.querySelectorAll('.notepad-dropdown-content').forEach(dropdown => {
                        dropdown.style.display = 'none';
                    });
                }
            });


            windowElement.querySelectorAll('.menu-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    const action = e.target.dataset.action;
                    switch (action) {
                        case 'new-file':
                            addNotepadTab('Untitled', '', ['Desktop']);
                            break;
                        case 'open-file':
                            showCustomAlert('Opening files from disk is not supported in this web OS. Please open files via Finder.', 'Feature Not Available');
                            break;
                        case 'save-file':
                            saveNotepadFile();
                            break;
                        case 'close-tab':
                            if (windowElement.activeTabId) {
                                closeNotepadTab(windowElement.activeTabId);
                            }
                            break;
                        case 'cut':
                            document.execCommand('cut');
                            break;
                        case 'copy':
                            document.execCommand('copy');
                            break;
                        case 'paste':
                            document.execCommand('paste');
                            break;
                        case 'zoom-in':
                            updateNotepadFontSize(2);
                            break;
                        case 'zoom-out':
                            updateNotepadFontSize(-2);
                            break;
                        case 'reset-zoom':
                            const activeTab = windowElement.notepadTabs.find(t => t.id === windowElement.activeTabId);
                            if (activeTab) {
                                activeTab.fontSize = 16;
                                renderNotepad();
                            }
                            break;
                    }
                    e.target.closest('.notepad-dropdown-content').style.display = 'none';
                });
            });
        }

        function getOfficeAppContent(appName, fileName = 'Untitled', fileContent = '', parentPath = []) {
            let iconClass = '';
            let appTitle = applications[appName].name;
            let contentHtml = '';

            switch (appName) {
                case 'word': iconClass = 'fas fa-file-word text-blue-500'; break;
                case 'powerpoint': iconClass = 'fas fa-file-powerpoint text-red-500'; break;
                case 'excel': iconClass = 'fas fa-file-excel text-green-500'; break;
                case 'photos': iconClass = 'fas fa-image text-purple-500'; break;
            }

            if (appName === 'photos') {
                contentHtml = `
                    <div class="photo-viewer-content">
                        <img id="photo-display-img" class="max-w-full max-h-[80%] object-contain mb-4" src="https://placehold.co/300x200/007AFF/FFFFFF?text=Image+Placeholder" alt="Image Content" onerror="this.src='https://placehold.co/300x200/FF0000/FFFFFF?text=Error+Loading+Image';">
                        <p class="text-sm">Image Description: <span id="photo-content-text">${fileContent || 'No image content provided.'}</span></p>
                        <p class="text-xs mt-4">This is a placeholder for a full Photos Viewer interface.</p>
                    </div>
                `;
            } else if (appName === 'excel') {
                contentHtml = `
                    <div class="excel-formula-bar">
                        <span>fx</span>
                        <input type="text" id="excel-formula-input" class="excel-formula-input" placeholder="Enter formula or value">
                    </div>
                    <div class="excel-grid-container">
                        <table class="excel-table" id="excel-grid">
                        </table>
                    </div>
                `;
            } else if (appName === 'powerpoint') {
                contentHtml = `
                    <div class="powerpoint-layout">
                        <div class="powerpoint-sidebar">
                        </div>
                        <div class="powerpoint-main-content">
                            <div class="powerpoint-slide-area">
                                <div class="office-content-editable flex-grow" contenteditable="true" style="font-size: 16px;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="powerpoint-controls">
                        <button id="add-slide-btn">Add Slide</button>
                        <button id="delete-slide-btn">Delete Slide</button>
                    </div>
                `;
            }
            else {
                contentHtml = `
                    <div class="office-content-editable flex-grow" contenteditable="true" style="font-size: 16px;">${fileContent}</div>
                `;
            }

            const menuBarHtml = `
                <div class="notepad-menu-bar">
                    <div class="notepad-menu-item" data-menu-id="file-menu">File
                        <div class="notepad-dropdown-content">
                            <div class="menu-option" data-action="new-file">New</div>
                            <div class="menu-option" data-action="open-file">Open...</div>
                            <div class="menu-option" data-action="save-file">Save</div>
                            ${appName === 'photos' ? '<div class="menu-option" data-action="import-image">Import Image (URL)</div>' : ''}
                            <div class="menu-option" data-action="export-file">Export...</div>
                            <div class="notepad-dropdown-separator"></div>
                            <div class="menu-option" data-action="print">Print...</div>
                        </div>
                    </div>
                    <div class="notepad-menu-item" data-menu-id="view-menu">View
                        <div class="notepad-dropdown-content">
                            <div class="menu-option" data-action="zoom-in">Zoom In</div>
                            <div class="menu-option" data-action="zoom-out">Zoom Out</div>
                            <div class="menu-option" data-action="reset-zoom">Reset Zoom</div>
                        </div>
                    </div>
                </div>
            `;

            const ribbonBarHtml = `
                ${appName !== 'photos' && appName !== 'excel' ? `
                <div class="office-ribbon-bar">
                    <button data-action="cut"><i class="fas fa-cut"></i> Cut</button>
                    <button data-action="copy"><i class="fas fa-copy"></i> Copy</button>
                    <button data-action="paste"><i class="fas fa-paste"></i> Paste</button>
                    <div class="w-px h-6 bg-gray-600 mx-2"></div>
                    <button data-action="font-bold"><i class="fas fa-bold"></i> Bold</button>
                    <button data-action="font-italic"><i class="fas fa-italic"></i> Italic</button>
                </div>
                ` : ''}
            `;

            return `
                ${menuBarHtml}
                ${ribbonBarHtml}
                <div class="notepad-tabs-container hidden"></div>
                <div class="notepad-content-area flex-grow flex flex-col">
                    ${contentHtml}
                </div>
            `;
        }

        function setupOfficeApp(windowElement, appName, fileName, fileContent, parentPath) {
            windowElement.currentFile = { name: fileName, parentPath: parentPath, type: appName };
            windowElement.savedRange = null;

            const menuBar = windowElement.querySelector('.notepad-menu-bar');
            const contentArea = windowElement.querySelector('.notepad-content-area');
            const ribbonBar = windowElement.querySelector('.office-ribbon-bar');

            let contentEditableDiv = null;
            let photoDisplayImg = null;
            let photoContentTextSpan = null;

            if (appName === 'word') {
                contentEditableDiv = contentArea.querySelector('.office-content-editable');
                if (contentEditableDiv) {
                    windowElement.currentFile.content = fileContent;
                    contentEditableDiv.innerHTML = fileContent;
                    contentEditableDiv.addEventListener('input', (e) => {
                        windowElement.currentFile.content = e.target.innerHTML;
                    });
                    contentEditableDiv.focus();
                }
            } else if (appName === 'photos') {
                photoDisplayImg = contentArea.querySelector('#photo-display-img');
                photoContentTextSpan = contentArea.querySelector('#photo-content-text');
                windowElement.currentFile.content = fileContent;
                if (photoContentTextSpan) {
                    photoContentTextSpan.textContent = fileContent || 'No image content provided.';
                }
            } else if (appName === 'excel') {
                const excelGrid = contentArea.querySelector('#excel-grid');
                const formulaInput = contentArea.querySelector('#excel-formula-input');
                const excelGridContainer = contentArea.querySelector('.excel-grid-container');
                let selectedCell = null;
                let currentScrollTop = 0;
                let currentScrollLeft = 0;

                windowElement.currentFile.data = fileContent.cells || {};

                function getColumnLetter(colIndex) {
                    let letter = '';
                    let tempColIndex = colIndex;
                    while (tempColIndex >= 0) {
                        letter = String.fromCharCode(65 + (tempColIndex % 26)) + letter;
                        tempColIndex = Math.floor(tempColIndex / 26) - 1;
                    }
                    return letter;
                }

                function parseCellReference(ref) {
                    const match = ref.match(/^([A-Z]+)(\d+)$/);
                    if (!match) return null;
                    const colStr = match[1];
                    const row = parseInt(match[2], 10) - 1;

                    let col = 0;
                    for (let i = 0; i < colStr.length; i++) {
                        col = col * 26 + (colStr.charCodeAt(i) - 65 + 1);
                    }
                    col--;

                    return { row, col };
                }

                function calculateFormula(formula) {
                    if (formula.startsWith('=SUM(') && formula.endsWith(')')) {
                        const range = formula.substring(5, formula.length - 1);
                        const parts = range.split(':');
                        if (parts.length !== 2) return '#ERROR!';

                        const startCellRef = parseCellReference(parts[0].toUpperCase());
                        const endCellRef = parseCellReference(parts[1].toUpperCase());

                        if (!startCellRef || !endCellRef) return '#ERROR!';

                        let sum = 0;
                        let hasNonNumeric = false;

                        const startRow = Math.min(startCellRef.row, endCellRef.row);
                        const endRow = Math.max(startCellRef.row, endCellRef.row);
                        const startCol = Math.min(startCellRef.col, endCellRef.col);
                        const endCol = Math.max(startCellRef.col, endCellRef.col);

                        for (let r = startRow; r <= endRow; r++) {
                            for (let c = startCol; c <= endCol; c++) {
                                const cellId = `${getColumnLetter(c)}${r + 1}`;
                                const cellData = windowElement.currentFile.data[cellId];
                                let value = cellData ? parseFloat(cellData.value) : 0;
                                if (isNaN(value)) {
                                    hasNonNumeric = true;
                                    break;
                                }
                                sum += value;
                            }
                            if (hasNonNumeric) break;
                        }
                        return hasNonNumeric ? '#VALUE!' : sum;
                    }
                    return '#ERROR!';
                }

                function updateCellDisplay(cellId, cellElement) {
                    const cellData = windowElement.currentFile.data[cellId];
                    if (cellData.formula) {
                        cellElement.textContent = calculateFormula(cellData.formula);
                    } else {
                        cellElement.textContent = cellData.content;
                    }
                }

                function recalculateAllFormulas() {
                    const allCells = excelGrid.querySelectorAll('td[data-cell-id]');
                    allCells.forEach(cellElement => {
                        const cellId = cellElement.dataset.cellId;
                        const cellData = windowElement.currentFile.data[cellId];
                        if (cellData && cellData.formula) {
                            updateCellDisplay(cellId, cellElement);
                        }
                    });
                }

                function renderExcelGrid() {
                    excelGrid.innerHTML = '';
                    const numRows = 20;
                    const numCols = 10;

                    const headerRow = excelGrid.insertRow();
                    headerRow.insertCell().textContent = '';
                    for (let c = 0; c < numCols; c++) {
                        const th = document.createElement('th');
                        th.textContent = getColumnLetter(c);
                        headerRow.appendChild(th);
                    }

                    for (let r = 0; r < numRows; r++) {
                        const row = excelGrid.insertRow();
                        const rowHeader = row.insertCell();
                        rowHeader.textContent = r + 1;
                        rowHeader.classList.add('excel-table-row-header');

                        for (let c = 0; c < numCols; c++) {
                            const cell = row.insertCell();
                            const cellId = `${getColumnLetter(c)}${r + 1}`;
                            cell.dataset.cellId = cellId;
                            cell.contentEditable = true;
                            cell.classList.add('excel-cell');

                            let cellData = windowElement.currentFile.data[cellId];
                            if (!cellData) {
                                cellData = { content: '', formula: null, value: '' };
                                windowElement.currentFile.data[cellId] = cellData;
                            }

                            updateCellDisplay(cellId, cell);

                            cell.addEventListener('focus', (e) => {
                                if (selectedCell) {
                                    selectedCell.classList.remove('selected');
                                }
                                selectedCell = e.target;
                                selectedCell.classList.add('selected');
                                const currentCellData = windowElement.currentFile.data[cellId];
                                formulaInput.value = currentCellData.formula || currentCellData.content;

                                currentScrollTop = excelGridContainer.scrollTop;
                                currentScrollLeft = excelGridContainer.scrollLeft;
                            });

                            cell.addEventListener('input', (e) => {
                                const cellId = e.target.dataset.cellId;
                                const cellData = windowElement.currentFile.data[cellId];
                                cellData.content = e.target.textContent;
                                cellData.formula = null;
                                cellData.value = parseFloat(e.target.textContent) || e.target.textContent;

                                const selection = window.getSelection();
                                const range = selection.rangeCount > 0 ? selection.getRangeAt(0) : null;

                                recalculateAllFormulas();

                                excelGridContainer.scrollTop = currentScrollTop;
                                excelGridContainer.scrollLeft = currentScrollLeft;

                                if (range) {
                                    selection.removeAllRanges();
                                    selection.addRange(range);
                                }
                            });

                            cell.addEventListener('blur', (e) => {
                                const cellId = e.target.dataset.cellId;
                                const currentCellData = windowElement.currentFile.data[cellId];
                                currentCellData.content = e.target.textContent;
                                currentCellData.value = parseFloat(e.target.textContent) || e.target.textContent;
                                recalculateAllFormulas();
                                excelGridContainer.scrollTop = currentScrollTop;
                                excelGridContainer.scrollLeft = currentScrollLeft;
                            });
                        }
                    }
                }

                formulaInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && selectedCell) {
                        const cellId = selectedCell.dataset.cellId;
                        const input = formulaInput.value.trim();
                        const cellData = windowElement.currentFile.data[cellId];

                        if (input.startsWith('=')) {
                            cellData.formula = input;
                            cellData.content = '';
                            cellData.value = calculateFormula(input);
                        } else {
                            cellData.formula = null;
                            cellData.content = input;
                            cellData.value = parseFloat(input) || input;
                        }
                        updateCellDisplay(cellId, selectedCell);
                        recalculateAllFormulas();
                        selectedCell.focus();
                    }
                });

                renderExcelGrid();
                recalculateAllFormulas();
            } else if (appName === 'powerpoint') {
                const sidebar = contentArea.querySelector('.powerpoint-sidebar');
                const slideArea = windowElement.querySelector('.powerpoint-slide-area .office-content-editable');
                const addSlideBtn = contentArea.querySelector('#add-slide-btn');
                const deleteSlideBtn = contentArea.querySelector('#delete-slide-btn');

                windowElement.currentFile.slides = fileContent.slides || [{ content: '<h2>New Slide</h2><p>Click to add text</p>' }];
                windowElement.currentFile.activeSlideIndex = 0;

                function renderPowerPoint() {
                    sidebar.innerHTML = '';

                    if (windowElement.currentFile.slides.length === 0) {
                        windowElement.currentFile.slides.push({ content: '<h2>New Slide</h2><p>Click to add text</p>' });
                        windowElement.currentFile.activeSlideIndex = 0;
                    }

                    windowElement.currentFile.slides.forEach((slide, index) => {
                        const thumbnailDiv = document.createElement('div');
                        thumbnailDiv.className = `powerpoint-slide-thumbnail ${index === windowElement.currentFile.activeSlideIndex ? 'active' : ''}`;
                        thumbnailDiv.dataset.slideIndex = index;
                        
                        const previewContent = document.createElement('div');
                        previewContent.className = 'powerpoint-thumbnail-content';
                        previewContent.innerHTML = slide.content;

                        thumbnailDiv.innerHTML = `<span>${index + 1}</span>`;
                        thumbnailDiv.appendChild(previewContent);

                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'powerpoint-slide-delete-btn';
                        deleteBtn.innerHTML = 'Ã—';
                        deleteBtn.dataset.slideIndex = index;
                        deleteBtn.title = 'Delete Slide';
                        thumbnailDiv.appendChild(deleteBtn);

                        sidebar.appendChild(thumbnailDiv);

                        thumbnailDiv.addEventListener('click', (e) => {
                            if (!e.target.classList.contains('powerpoint-slide-delete-btn')) {
                                switchPowerPointSlide(index);
                            }
                        });

                        deleteBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            deletePowerPointSlide(parseInt(e.target.dataset.slideIndex));
                        });
                    });

                    slideArea.innerHTML = windowElement.currentFile.slides[windowElement.currentFile.activeSlideIndex].content;
                    slideArea.focus();
                }

                function updateSlideContent(e) {
                    windowElement.currentFile.slides[windowElement.currentFile.activeSlideIndex].content = e.target.innerHTML;
                    renderPowerPoint();
                }

                function switchPowerPointSlide(index) {
                    windowElement.currentFile.activeSlideIndex = index;
                    renderPowerPoint();
                }

                function addPowerPointSlide() {
                    windowElement.currentFile.slides.push({ content: '<h2>New Slide</h2><p>Click to add text</p>' });
                    windowElement.currentFile.activeSlideIndex = windowElement.currentFile.slides.length - 1;
                    renderPowerPoint();
                }

                function deletePowerPointSlide(indexToDelete) {
                    if (windowElement.currentFile.slides.length <= 1) {
                        showCustomAlert('Cannot delete the last slide.', 'Deletion Error');
                        return;
                    }
                    showCustomConfirm(`Are you sure you want to delete Slide ${indexToDelete + 1}?`, (confirmResult) => {
                        if (confirmResult) {
                            windowElement.currentFile.slides.splice(indexToDelete, 1);
                            if (windowElement.currentFile.activeSlideIndex >= indexToDelete) {
                                windowElement.currentFile.activeSlideIndex = Math.max(0, windowElement.currentFile.activeSlideIndex - 1);
                            }
                            renderPowerPoint();
                        }
                    }, 'Delete Slide');
                }

                addSlideBtn.addEventListener('click', addPowerPointSlide);
                deleteSlideBtn.addEventListener('click', deletePowerPointSlide.bind(null, windowElement.currentFile.activeSlideIndex));

                renderPowerPoint();
            }


            menuBar.querySelectorAll('.notepad-menu-item').forEach(menuItem => {
                menuItem.addEventListener('mousedown', (e) => {
                    const selection = window.getSelection();
                    if (selection.rangeCount > 0) {
                        windowElement.savedRange = selection.getRangeAt(0);
                    } else {
                        windowElement.savedRange = null;
                    }

                    menuBar.querySelectorAll('.notepad-dropdown-content').forEach(dropdown => {
                        if (dropdown !== menuItem.querySelector('.notepad-dropdown-content')) {
                            dropdown.style.display = 'none';
                        }
                    });

                    const dropdown = menuItem.querySelector('.notepad-dropdown-content');
                    if (dropdown) {
                        dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                    }
                });
            });

            windowElement.addEventListener('click', (e) => {
                if (!e.target.closest('.notepad-menu-bar')) {
                    menuBar.querySelectorAll('.notepad-dropdown-content').forEach(dropdown => {
                        dropdown.style.display = 'none';
                    });
                }
            });

            if (ribbonBar) {
                ribbonBar.querySelectorAll('button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const action = e.currentTarget.dataset.action;
                        let targetContentEditable = null;
                        if (appName === 'word') {
                            targetContentEditable = contentEditableDiv;
                        } else if (appName === 'powerpoint') {
                            targetContentEditable = windowElement.querySelector('.powerpoint-slide-area .office-content-editable');
                        }

                        if (['cut', 'copy', 'paste', 'font-bold', 'font-italic'].includes(action) && windowElement.savedRange) {
                            const selection = window.getSelection();
                            selection.removeAllRanges();
                            selection.addRange(windowElement.savedRange);

                            if (targetContentEditable) {
                                targetContentEditable.focus();
                            }
                        }

                        switch (action) {
                            case 'cut':
                                document.execCommand('cut');
                                break;
                            case 'copy':
                                document.execCommand('copy');
                                break;
                            case 'paste':
                                document.execCommand('paste');
                                break;
                            case 'font-bold':
                                if (targetContentEditable) {
                                    document.execCommand('bold');
                                } else {
                                    showNotification('No editable content area found for formatting.', 'error', 'Formatting Error');
                                }
                                break;
                            case 'font-italic':
                                if (targetContentEditable) {
                                    document.execCommand('italic');
                                } else {
                                    showNotification('No editable content area found for formatting.', 'error', 'Formatting Error');
                                }
                                break;
                        }
                    });
                });
            }

            menuBar.querySelectorAll('.menu-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    const action = e.target.dataset.action;

                    let targetContentEditable = null;
                    if (appName === 'word') {
                        targetContentEditable = contentEditableDiv;
                    } else if (appName === 'powerpoint') {
                        targetContentEditable = windowElement.querySelector('.powerpoint-slide-area .office-content-editable');
                    } else if (appName === 'excel') {
                        if (selectedCell) {
                            targetContentEditable = selectedCell;
                        }
                    }

                    if (['cut', 'copy', 'paste', 'font-bold', 'font-italic'].includes(action) && windowElement.savedRange) {
                        const selection = window.getSelection();
                        selection.removeAllRanges();
                        selection.addRange(windowElement.savedRange);

                        if (targetContentEditable) {
                            targetContentEditable.focus();
                        }
                    }

                    switch (action) {
                        case 'new-file':
                            showCustomPrompt(`Enter name for new ${appName} document:`, `Untitled.${appName === 'word' ? 'docx' : appName === 'powerpoint' ? 'pptx' : appName === 'excel' ? 'xlsx' : 'jpg'}`, (newName) => {
                                if (newName) {
                                    const currentFolder = traversePath(windowElement.currentFile.parentPath);
                                    if (currentFolder && currentFolder.type === 'folder') {
                                        if (!currentFolder.contents[newName]) {
                                            let initialContent = '';
                                            if (appName === 'word') initialContent = '<h1>New Document</h1><p>Start typing here...</p>';
                                            if (appName === 'powerpoint') initialContent = { slides: [{ content: '<h2>New Presentation</h2><p>Click to add text</p>' }] };
                                            if (appName === 'excel') initialContent = { cells: {} };
                                            if (appName === 'photos') initialContent = 'A new blank image file.';

                                            currentFolder.contents[newName] = { type: appName, content: initialContent };
                                            showCustomAlert(`New ${appName} document "${newName}" created.`);
                                            launchApp(appName, newName, initialContent, windowElement.currentFile.parentPath);
                                            if (openWindows[appName].length > 1) {
                                                windowElement.querySelector('.close-btn').click();
                                            }
                                            initializeDesktopIcons();
                                            updateFinderWindows(windowElement.currentFile.parentPath);
                                        } else {
                                            showCustomAlert('File already exists in this directory.', 'Creation Error');
                                        }
                                    }
                                }
                            });
                            break;
                        case 'open-file':
                            showCustomAlert('Opening files from disk is not supported in this web OS. Please open files via Finder.', 'Feature Not Available');
                            break;
                        case 'save-file':
                            const fileInFs = traversePath([...windowElement.currentFile.parentPath, windowElement.currentFile.name]);
                            if (fileInFs) {
                                if (appName === 'photos') {
                                    fileInFs.content = photoContentTextSpan ? photoContentTextSpan.textContent : '';
                                } else if (appName === 'excel') {
                                    fileInFs.content = { cells: windowElement.currentFile.data };
                                } else if (appName === 'powerpoint') {
                                    fileInFs.content = { slides: windowElement.currentFile.slides };
                                }
                                else {
                                    fileInFs.content = contentEditableDiv ? contentEditableDiv.innerHTML : '';
                                }
                                showCustomAlert(`Saving "${windowElement.currentFile.name}"... (Changes are not persistent across sessions)`, 'Save Successful');
                            } else {
                                showCustomAlert(`Could not find file "${windowElement.currentFile.name}" to save.`, 'Save Error');
                            }
                            break;
                        case 'import-image':
                            if (appName === 'photos') {
                                showCustomPrompt('Enter image URL:', 'https://placehold.co/300x200/007AFF/FFFFFF?text=Imported+Image', (imageUrl) => {
                                    if (imageUrl) {
                                        if (photoDisplayImg) {
                                            photoDisplayImg.src = imageUrl;
                                            if (photoContentTextSpan) {
                                                photoContentTextSpan.textContent = `Imported from: ${imageUrl}`;
                                                windowElement.currentFile.content = photoContentTextSpan.textContent;
                                            }
                                            showCustomAlert('Image imported successfully (displayed from URL).', 'Image Import');
                                        }
                                    }
                                });
                            }
                            break;
                        case 'export-file':
                            showCustomAlert(`Exporting "${windowElement.currentFile.name}"... (Simulated)`, 'Export');
                            break;
                        case 'print':
                            showCustomAlert(`Printing "${windowElement.currentFile.name}"... (Simulated)`, 'Print');
                            break;
                        case 'zoom-in':
                            if (contentEditableDiv) {
                                let currentSize = parseFloat(getComputedStyle(contentEditableDiv).fontSize);
                                contentEditableDiv.style.fontSize = `${currentSize + 2}px`;
                            }
                            break;
                        case 'zoom-out':
                            if (contentEditableDiv) {
                                let currentSize = parseFloat(getComputedStyle(contentEditableDiv).fontSize);
                                contentEditableDiv.style.fontSize = `${Math.max(8, currentSize - 2)}px`;
                            }
                            break;
                        case 'reset-zoom':
                            if (contentEditableDiv) {
                                contentEditableDiv.style.fontSize = '16px';
                            }
                            break;
                        default:
                            showCustomAlert(`"${e.target.textContent}" functionality not yet implemented.`, 'Feature Not Available');
                            break;
                    }
                    e.target.closest('.notepad-dropdown-content').style.display = 'none';
                });
            });
        }


        function openAppLauncher() {
            const appLauncherWindow = createWindow('applauncher', 'Applications', `
                <div class="app-launcher-grid h-full">
                </div>
            `, 600, 500);

            if (appLauncherWindow) {
                const appGrid = appLauncherWindow.querySelector('.app-launcher-grid');
                appGrid.innerHTML = '';

                for (const appKey in applications) {
                    const app = applications[appKey];
                    const appItem = document.createElement('div');
                    appItem.className = 'app-launcher-item';
                    appItem.dataset.appName = appKey;

                    let iconHtml = '';
                    if (app.icon.startsWith('fas ') || app.icon.startsWith('fab ')) {
                        iconHtml = `<i class="${app.icon}"></i>`;
                    } else {
                        iconHtml = `<img src="${app.icon}" alt="${app.name}" class="w-12 h-12 rounded-lg">`;
                    }

                    appItem.innerHTML = `
                        ${iconHtml}
                        <span>${app.name}</span>
                    `;
                    appGrid.appendChild(appItem);

                    appItem.addEventListener('click', () => {
                        appLauncherWindow.querySelector('.close-btn').click();
                        launchApp(appKey);
                    });
                }
            }
        }

        function renderDock() {
            dockContainer.innerHTML = '';

            dockedAppsState.forEach(appKey => {
                const app = applications[appKey];
                if (!app) {
                    console.warn(`Attempted to render dock item for unknown app: ${appKey}`);
                    return;
                }
                const dockItem = document.createElement('div');
                dockItem.className = 'dock-item';
                dockItem.dataset.app = appKey;

                let iconHtml = '';
                if (app.icon.startsWith('fas ') || app.icon.startsWith('fab ')) {
                    iconHtml = `<i class="${app.icon}"></i>`;
                } else {
                    iconHtml = `<img src="${app.icon}" alt="${app.name}" class="rounded-lg">`;
                }

                dockItem.innerHTML = iconHtml;

                dockContainer.appendChild(dockItem);

                const appWindows = openWindows[appKey];
                const activeWindows = appWindows.filter(win => win.style.display !== 'none');
                const minimizedWindows = appWindows.filter(win => win.style.display === 'none');

                if (activeWindows.length > 0) {
                    dockItem.classList.add('active');
                    dockItem.classList.remove('minimized');
                } else if (minimizedWindows.length > 0) {
                    dockItem.classList.add('minimized');
                    dockItem.classList.remove('active');
                } else {
                    dockItem.classList.remove('active');
                    dockItem.classList.remove('minimized');
                }

                dockItem.addEventListener('click', () => {
                    launchApp(appKey);
                });

                dockItem.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    hideAllContextMenus();
                    currentDockContextItem = dockItem;
                    
                    const unpinOption = dockItemContextMenu.querySelector('[data-action="unpin-from-dock"]');
                    const pinOption = dockItemContextMenu.querySelector('[data-action="pin-to-dock"]');

                    if (applications[appKey].pinned) {
                        unpinOption.style.display = 'block';
                        pinOption.style.display = 'none';
                    } else {
                        unpinOption.style.display = 'none';
                        pinOption.style.display = 'block';
                    }

                    dockItemContextMenu.style.left = `${e.clientX}px`;
                    dockItemContextMenu.style.top = `${e.clientY}px`;
                    dockItemContextMenu.style.display = 'block';
                });
            });

            const currentDockItems = document.querySelectorAll('#dock-container .dock-item');

            function handleDockMouseMove(e) {
                const dockRect = dockContainer.getBoundingClientRect();
                const mouseX = e.clientX;

                currentDockItems.forEach(item => {
                    const itemRect = item.getBoundingClientRect();
                    const itemCenterX = itemRect.left + itemRect.width / 2;
                    const distance = Math.abs(mouseX - itemCenterX);

                    let scale = 1;
                    const maxScale = 1.5;
                    const maxInfluenceDistance = 70;
                    if (distance < maxInfluenceDistance) {
                        scale = 1 + (maxScale - 1) * (1 - (distance / maxInfluenceDistance));
                    }
                    item.style.transform = `scale(${scale})`;
                });
            }

            function handleDockMouseLeave() {
                currentDockItems.forEach(item => {
                    item.style.transform = 'scale(1)';
                });
            }

            dockContainer.removeEventListener('mousemove', handleDockMouseMove);
            dockContainer.removeEventListener('mouseleave', handleDockMouseLeave);

            dockContainer.addEventListener('mousemove', handleDockMouseMove);
            dockContainer.addEventListener('mouseleave', handleDockMouseLeave);
        }

        function launchApp(appName, fileName = 'Untitled', fileContent = '', parentPath = []) {
            let newWindow = null;
            let content = '';
            let title = applications[appName].name;

            const existingWindows = openWindows[appName].filter(win => win.parentNode === desktop);
            if (existingWindows.length > 0) {
                const minimizedWindow = existingWindows.find(win => win.style.display === 'none');
                if (minimizedWindow) {
                    minimizedWindow.style.display = 'flex';
                    minimizedWindow.dispatchEvent(new Event('mousedown'));
                    const dockItem = document.querySelector(`.dock-item[data-app="${appName}"]`);
                    if (dockItem) {
                        dockItem.classList.remove('minimized');
                        dockItem.classList.add('active');
                    }
                    updateStatusBarAppName();
                    return;
                } else {
                    existingWindows[0].dispatchEvent(new Event('mousedown'));
                    return;
                }
            }

            if (!dockedAppsState.includes(appName) && !applications[appName].pinned) {
                dockedAppsState.push(appName);
                renderDock();
            } else if (dockedAppsState.includes(appName)) {
                const dockItem = document.querySelector(`.dock-item[data-app="${appName}"]`);
                if (dockItem) {
                    dockItem.classList.add('active');
                    dockItem.classList.remove('minimized');
                }
            }


            switch (appName) {
                case 'applauncher':
                    openAppLauncher();
                    return;
                case 'finder':
                    content = `
                        <div class="flex h-full">
                            <div class="finder-sidebar">
                                <h3 class="text-xs text-gray-400 uppercase mb-2">Favorites</h3>
                                <div class="finder-sidebar-item flex items-center mb-1" data-path="Desktop">
                                    <i class="fas fa-desktop text-blue-400 mr-2"></i>
                                    <span>Desktop</span>
                                </div>
                                <div class="finder-sidebar-item flex items-center mb-1" data-path="Documents">
                                    <i class="fas fa-folder text-blue-400 mr-2"></i>
                                    <span>Documents</span>
                                </div>
                                <div class="finder-sidebar-item flex items-center mb-1" data-path="Downloads">
                                    <i class="fas fa-download text-blue-400 mr-2"></i>
                                    <span>Downloads</span>
                                </div>
                                <div class="finder-sidebar-item flex items-center mb-1" data-path="Applications">
                                    <i class="fas fa-star text-yellow-400 mr-2"></i>
                                    <span>Applications</span>
                                </div>
                                <div class="finder-sidebar-item flex items-center mb-1" data-path="Recycle Bin">
                                    <i class="fas fa-trash-alt text-gray-400 mr-2"></i>
                                    <span>Recycle Bin</span>
                                </div>
                            </div>
                            <div class="flex flex-col flex-grow">
                                <div class="finder-path-bar"></div>
                                <div class="finder-main-content flex-grow overflow-y-auto">
                                </div>
                            </div>
                        </div>
                    `;
                    newWindow = createWindow(appName, title, content, 800, 500);
                    if (newWindow) {
                        newWindow.currentPath = ['Desktop'];
                        renderFinderContent(newWindow, newWindow.currentPath);

                        newWindow.querySelectorAll('.finder-sidebar-item').forEach(item => {
                            item.addEventListener('click', (e) => {
                                const targetPath = e.currentTarget.dataset.path;
                                if (targetPath === 'Applications') {
                                    newWindow.currentPath = ['Desktop', 'Applications'];
                                } else {
                                    newWindow.currentPath = [targetPath];
                                }
                                renderFinderContent(newWindow, newWindow.currentPath);
                            });
                        });
                    }
                    break;
                case 'terminal':
                    content = `
                        <div class="bg-black text-green-400 p-4 rounded-md font-mono text-sm h-full flex flex-col">
                            <div class="terminal-output flex-grow overflow-y-auto">
                                <p>koliteOS:~ user$ Welcome to koliteOS Terminal!</p>
                                <p>koliteOS:~ user$ Type 'help' for commands.</p>
                            </div>
                            <div class="flex items-center mt-2">
                                <span class="text-green-400">koliteOS:~ user$</span>
                                <input type="text" class="terminal-input bg-transparent border-none outline-none text-green-400 ml-2 flex-grow" autofocus>
                            </div>
                        </div>
                    `;
                    newWindow = createWindow(appName, title, content, 700, 450);
                    if (newWindow) {
                        setupTerminal(newWindow);
                        setTimeout(() => newWindow.querySelector('.terminal-input').focus(), 100);
                    }
                    break;
                case 'settings':
                    content = `
                        <h2 class="text-xl font-semibold mb-4">System Settings</h2>
                        <div class="space-y-6">
                            <div>
                                <h3 class="text-lg font-medium mb-3">Appearance</h3>
                                <div class="flex items-center space-x-4">
                                    <button id="theme-dark-btn" class="px-4 py-2 rounded-md bg-gray-700 hover:bg-gray-600 text-white transition-colors duration-200">Dark Mode</button>
                                    <button id="theme-light-btn" class="px-4 py-2 rounded-md bg-gray-200 hover:bg-gray-300 text-gray-800 transition-colors duration-200">Light Mode</button>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-lg font-medium mb-3">Wallpaper</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="wallpaper-option cursor-pointer border-2 border-transparent rounded-lg overflow-hidden p-1 transition-all duration-200" data-wallpaper="default-dark">
                                        <div class="w-full h-16 rounded-md" style="background: ${wallpapers['default-dark']};"></div>
                                        <p class="text-center text-sm mt-1">Dark Default</p>
                                    </div>
                                    <div class="wallpaper-option cursor-pointer border-2 border-transparent rounded-lg overflow-hidden p-1 transition-all duration-200" data-wallpaper="default-light">
                                        <div class="w-full h-16 rounded-md" style="background: ${wallpapers['default-light']};"></div>
                                        <p class="text-center text-sm mt-1">Light Default</p>
                                    </div>
                                    <div class="wallpaper-option cursor-pointer border-2 border-transparent rounded-lg overflow-hidden p-1 transition-all duration-200" data-wallpaper="space">
                                        <div class="w-full h-16 rounded-md" style="background: ${wallpapers['space']};"></div>
                                        <p class="text-center text-sm mt-1">Space</p>
                                    </div>
                                    <div class="wallpaper-option cursor-pointer border-2 border-transparent rounded-lg overflow-hidden p-1 transition-all duration-200" data-wallpaper="mountains">
                                        <div class="w-full h-16 rounded-md" style="background: ${wallpapers['mountains']};"></div>
                                        <p class="text-center text-sm mt-1">Mountains</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    newWindow = createWindow(appName, title, content, 500, 600);
                    if (newWindow) {
                        newWindow.querySelector('#theme-dark-btn').addEventListener('click', () => {
                            body.classList.remove('theme-light');
                            body.classList.add('theme-dark');
                            body.style.backgroundImage = 'none';
                            body.style.background = wallpapers['default-dark'];
                            currentWallpaper = 'default-dark';
                            newWindow.querySelectorAll('.wallpaper-option').forEach(opt => {
                                opt.classList.remove('border-blue-500');
                                opt.classList.add('border-transparent');
                                if (opt.dataset.wallpaper === currentWallpaper) {
                                    opt.classList.add('border-blue-500');
                                    opt.classList.remove('border-transparent');
                                }
                            });
                        });
                        newWindow.querySelector('#theme-light-btn').addEventListener('click', () => {
                            body.classList.remove('theme-dark');
                            body.classList.add('theme-light');
                            body.style.backgroundImage = 'none';
                            body.style.background = wallpapers['default-light'];
                            currentWallpaper = 'default-light';
                            newWindow.querySelectorAll('.wallpaper-option').forEach(opt => {
                                opt.classList.remove('border-blue-500');
                                opt.classList.add('border-transparent');
                                if (opt.dataset.wallpaper === currentWallpaper) {
                                    opt.classList.add('border-blue-500');
                                    opt.classList.remove('border-transparent');
                                }
                            });
                        });

                        newWindow.querySelectorAll('.wallpaper-option').forEach(option => {
                            option.addEventListener('click', (e) => {
                                const selectedWallpaper = e.currentTarget.dataset.wallpaper;
                                body.style.background = wallpapers[selectedWallpaper];
                                currentWallpaper = selectedWallpaper;

                                if (isWallpaperDark(selectedWallpaper)) {
                                    body.classList.remove('theme-light');
                                    body.classList.add('theme-dark');
                                } else {
                                    body.classList.remove('theme-dark');
                                    body.classList.add('theme-light');
                                }

                                newWindow.querySelectorAll('.wallpaper-option').forEach(opt => {
                                    opt.classList.remove('border-blue-500');
                                    opt.classList.add('border-transparent');
                                });
                                e.currentTarget.classList.add('border-blue-500');
                                e.currentTarget.classList.remove('border-transparent');
                            });

                            if (option.dataset.wallpaper === currentWallpaper) {
                                option.classList.add('border-blue-500');
                                option.classList.remove('border-transparent');
                            }
                        });
                    }
                    break;
                case 'notepad':
                    content = getNotepadInitialContent();
                    newWindow = createWindow(appName, title, content, 600, 400);
                    if (newWindow) {
                        setupNotepad(newWindow);
                        if (fileName !== 'Untitled' && fileContent !== '') {
                            newWindow.notepadAPI.addTab(fileName, fileContent, parentPath);
                        }
                    }
                    break;
                case 'minigame':
                    content = `
                        <div class="flex flex-col items-center justify-center h-full">
                            <div class="text-lg font-bold mb-4">
                                Score: <span id="game-score">0</span> | Time: <span id="game-timer">30</span>s
                            </div>
                            <div id="game-area" class="relative w-full h-64 bg-gray-700 rounded-lg overflow-hidden mb-4 border-2 border-gray-600 shadow-inner">
                            </div>
                            <button id="game-start-btn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200">Start Game</button>
                            <p id="game-message" class="mt-2 text-sm text-gray-300"></p>
                        </div>
                    `;
                    newWindow = createWindow(appName, title, content, 500, 450);
                    if (newWindow) {
                        const startButton = newWindow.querySelector('#game-start-btn');
                        startButton.addEventListener('click', () => startGame(newWindow));
                        newWindow.addEventListener('remove', () => {
                            clearInterval(gameInterval);
                            clearInterval(gameTimer);
                        });
                    }
                    break;
                case 'about':
                    content = `
                        <div class="text-center">
                            <h2 class="text-2xl font-bold mb-2">koliteOS</h2>
                            <p class="text-lg text-gray-300 mb-4">Web OS made by Dakshit Singh</p>
                            <p class="text-gray-400">Credits: MAde to reality by Font Awesome and tailwind CSS</p>
                            <p class="text-gray-400 mt-2">Built with HTML, Tailwind CSS, and JavaScript.</p>
                            <p class="mt-6">Â© 2025 koliteOS. All rights reserved.</p>
                        </div>
                    `;
                    newWindow = createWindow(appName, title, content, 400, 300);
                    break;
                case 'calculator':
                    content = `
                        <div class="calculator-grid">
                            <div class="calculator-display" id="calculator-display">0</div>
                            <button class="calculator-button clear" data-action="clear">AC</button>
                            <button class="calculator-button operator" data-action="negate">+/-</button>
                            <button class="calculator-button operator" data-action="percent">%</button>
                            <button class="calculator-button operator" data-action="divide">/</button>
                            <button class="calculator-button" data-action="7">7</button>
                            <button class="calculator-button" data-action="8">8</button>
                            <button class="calculator-button" data-action="9">9</button>
                            <button class="calculator-button operator" data-action="multiply">*</button>
                            <button class="calculator-button" data-action="4">4</button>
                            <button class="calculator-button" data-action="5">5</button>
                            <button class="calculator-button" data-action="6">6</button>
                            <button class="calculator-button operator" data-action="subtract">-</button>
                            <button class="calculator-button" data-action="1">1</button>
                            <button class="calculator-button" data-action="2">2</button>
                            <button class="calculator-button" data-action="3">3</button>
                            <button class="calculator-button operator" data-action="add">+</button>
                            <button class="calculator-button" data-action="0">0</button>
                            <button class="calculator-button" data-action="decimal">.</button>
                            <button class="calculator-button equals" data-action="equals">=</button>
                        </div>
                    `;
                    newWindow = createWindow(appName, title, content, 350, 500);
                    if (newWindow) {
                        setupCalculator(newWindow);
                    }
                    break;
                case 'word':
                case 'powerpoint':
                case 'excel':
                case 'photos':
                    content = getOfficeAppContent(appName, fileName, fileContent, parentPath);
                    newWindow = createWindow(appName, title, content, 700, 500);
                    if (newWindow) {
                        setupOfficeApp(newWindow, appName, fileName, fileContent, parentPath);
                    }
                    break;
                case 'recyclebin':
                    content = `
                        <div class="flex flex-col h-full">
                            <div class="finder-path-bar">Recycle Bin</div>
                            <div class="finder-main-content flex-grow overflow-y-auto"></div>
                            <div class="p-2 flex justify-end">
                                <button id="empty-trash-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors duration-200">Empty Recycle Bin</button>
                            </div>
                        </div>
                    `;
                    newWindow = createWindow(appName, title, content, 700, 500);
                    if (newWindow) {
                        newWindow.currentPath = ['Recycle Bin'];
                        renderFinderContent(newWindow, newWindow.currentPath);
                        newWindow.querySelector('#empty-trash-btn').addEventListener('click', () => {
                            showCustomConfirm('Are you sure you want to permanently delete all items in the Recycle Bin? This action cannot be undone.', (confirm) => {
                                if (confirm) {
                                    fileSystem['Recycle Bin'].contents = {};
                                    showCustomAlert('Recycle Bin emptied.', 'Recycle Bin');
                                    updateFinderWindows(['Recycle Bin']);
                                    initializeDesktopIcons();
                                }
                            }, 'Empty Recycle Bin');
                        });
                    }
                    break;
                case 'photopea':
                    content = `<div class="text-center text-xl p-4">Photopea (Web-based image editor) - Opening in new tab is not supported in this environment.</div>`;
                    newWindow = createWindow(appName, title, content, 700, 500);
                    break;
                case 'vscode':
                    content = `<div class="text-center text-xl p-4">VS Code (Web-based code editor) - Opening in new tab is not supported in this environment.</div>`;
                    newWindow = createWindow(appName, title, content, 700, 500);
                    break;
                case 'paint':
                    content = `
                        <div class="flex flex-col items-center h-full p-4">
                            <canvas id="paint-canvas" class="paint-canvas" width="600" height="400"></canvas>
                            <div class="flex space-x-4 mt-4">
                                <label for="color-picker">Color:</label>
                                <input type="color" id="color-picker" value="#000000">
                                <label for="brush-size">Size:</label>
                                <input type="range" id="brush-size" min="1" max="20" value="5">
                                <button id="clear-canvas" class="px-4 py-2 bg-red-500 text-white rounded-md">Clear</button>
                            </div>
                        </div>
                    `;
                    newWindow = createWindow(appName, title, content, 650, 550);
                    if (newWindow) {
                        setupPaint(newWindow);
                    }
                    break;
                case 'tictactoe':
                    content = `
                        <div class="flex flex-col items-center justify-center h-full">
                            <div id="tic-tac-toe-message" class="text-lg font-bold mb-4">Player X's Turn</div>
                            <div id="tic-tac-toe-grid" class="tic-tac-toe-grid">
                                <div class="tic-tac-toe-cell" data-cell-index="0"></div>
                                <div class="tic-tac-toe-cell" data-cell-index="1"></div>
                                <div class="tic-tac-toe-cell" data-cell-index="2"></div>
                                <div class="tic-tac-toe-cell" data-cell-index="3"></div>
                                <div class="tic-tac-toe-cell" data-cell-index="4"></div>
                                <div class="tic-tac-toe-cell" data-cell-index="5"></div>
                                <div class="tic-tac-toe-cell" data-cell-index="6"></div>
                                <div class="tic-tac-toe-cell" data-cell-index="7"></div>
                                <div class="tic-tac-toe-cell" data-cell-index="8"></div>
                            </div>
                            <button id="tic-tac-toe-reset" class="px-6 py-2 bg-blue-600 text-white rounded-lg mt-4">Reset Game</button>
                        </div>
                    `;
                    newWindow = createWindow(appName, title, content, 300, 450);
                    if (newWindow) {
                        setupTicTacToe(newWindow);
                    }
                    break;
                case 'snake':
                    content = `
                        <div class="flex flex-col items-center justify-center h-full">
                            <canvas id="snake-game-canvas" width="300" height="300"></canvas>
                            <div id="snake-score" class="text-xl font-bold mt-4">Score: 0</div>
                            <button id="snake-start-btn" class="px-6 py-2 bg-green-600 text-white rounded-lg mt-4">Start Game</button>
                        </div>
                    `;
                    newWindow = createWindow(appName, title, content, 350, 450);
                    if (newWindow) {
                        setupSnakeGame(newWindow);
                    }
                    break;
                case 'youtubeplayer':
                    content = `
                        <div class="youtube-player-container p-4">
                            <input type="text" id="youtube-url-input" class="youtube-player-input" placeholder="Enter YouTube video URL or ID">
                            <button id="youtube-load-btn" class="youtube-load-btn">Load Video</button>
                            <iframe id="youtube-iframe" class="youtube-iframe" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                        </div>
                    `;
                    newWindow = createWindow(appName, title, content, 800, 600);
                    if (newWindow) {
                        setupYouTubePlayer(newWindow);
                    }
                    break;
                case 'browser':
                    content = `
                        <div class="browser-container p-4">
                            <div class="browser-address-bar">
                                <input type="text" id="browser-address-input" class="browser-address-input" value="https://www.google.com">
                                <button id="browser-go-btn" class="browser-go-btn">Go</button>
                            </div>
                            <iframe id="browser-iframe" class="browser-iframe" src="about:blank"></iframe>
                        </div>
                    `;
                    newWindow = createWindow(appName, title, content, 1000, 700);
                    if (newWindow) {
                        setupBrowser(newWindow);
                    }
                    break;
                case 'xenosai':
                    content = `
                        <div class="flex flex-col h-full p-4">
                            <div class="flex-grow overflow-y-auto bg-gray-800 rounded-lg p-3 mb-3 text-sm" id="xenosai-output">
                                <p class="text-blue-400">XenosAI: Hello! How can I help you today?</p>
                            </div>
                            <div class="flex">
                                <input type="text" id="xenosai-input" class="flex-grow p-2 rounded-l-lg bg-gray-700 text-white border border-gray-600 outline-none" placeholder="Type your command...">
                                <button id="xenosai-send-btn" class="px-4 py-2 bg-blue-600 text-white rounded-r-lg hover:bg-blue-700">Send</button>
                            </div>
                        </div>
                    `;
                    newWindow = createWindow(appName, title, content, 500, 400);
                    if (newWindow) {
                        setupXenosAI(newWindow);
                    }
                    break;
                case 'musicplayer':
                    content = `
                        <div class="flex flex-col items-center justify-center h-full p-4">
                            <div class="bg-gray-800 rounded-lg p-6 w-full max-w-md shadow-lg">
                                <div class="flex justify-center mb-4">
                                    <img id="album-art" src="https://placehold.co/150x150/333333/FFFFFF?text=Album+Art" alt="Album Art" class="w-36 h-36 rounded-md shadow-md">
                                </div>
                                <div class="text-center mb-6">
                                    <h3 id="track-title" class="text-xl font-bold text-white">No Song Playing</h3>
                                    <p id="track-artist" class="text-gray-400">Select a song</p>
                                </div>
                                <div class="flex items-center mb-4">
                                    <span id="current-time-display" class="text-xs text-gray-400">0:00</span>
                                    <input type="range" id="music-progress" class="w-full mx-2 h-1 bg-gray-600 rounded-lg appearance-none cursor-pointer" value="0" min="0" max="100">
                                    <span id="duration-display" class="text-xs text-gray-400">0:00</span>
                                </div>
                                <div class="flex justify-center items-center space-x-6">
                                    <button id="prev-btn" class="text-gray-400 hover:text-white text-2xl"><i class="fas fa-backward"></i></button>
                                    <button id="play-pause-btn" class="bg-blue-600 text-white rounded-full w-12 h-12 flex items-center justify-center text-2xl shadow-lg hover:bg-blue-700">
                                        <i class="fas fa-play"></i>
                                    </button>
                                    <button id="next-btn" class="text-gray-400 hover:text-white text-2xl"><i class="fas fa-forward"></i></button>
                                </div>
                            </div>
                            <div class="mt-6 w-full max-w-md">
                                <h4 class="text-lg font-semibold mb-2">Playlist</h4>
                                <ul id="playlist" class="bg-gray-700 rounded-lg max-h-40 overflow-y-auto">
                                    <!-- Songs will be listed here -->
                                </ul>
                            </div>
                        </div>
                    `;
                    newWindow = createWindow(appName, title, content, 450, 650);
                    if (newWindow) {
                        setupMusicPlayer(newWindow);
                    }
                    break;
                case 'mail':
                    content = `
                        <div class="mail-layout">
                            <div class="mail-sidebar">
                                <button id="compose-mail-btn" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md mb-4 hover:bg-blue-700">Compose</button>
                                <div class="mail-sidebar-item active" data-view="inbox">
                                    <i class="fas fa-inbox mr-2"></i> Inbox
                                </div>
                                <div class="mail-sidebar-item" data-view="sent">
                                    <i class="fas fa-paper-plane mr-2"></i> Sent
                                </div>
                            </div>
                            <div class="mail-main-content">
                                <div id="mail-inbox-view">
                                    <h2 class="text-xl font-semibold mb-4">Inbox</h2>
                                    <div id="inbox-list"></div>
                                </div>
                                <div id="mail-sent-view" style="display:none;">
                                    <h2 class="text-xl font-semibold mb-4">Sent</h2>
                                    <div id="sent-list"></div>
                                </div>
                                <div id="mail-compose-view" style="display:none;">
                                    <h2 class="text-xl font-semibold mb-4">Compose New Mail</h2>
                                    <div class="mail-compose-form">
                                        <input type="text" id="mail-to" placeholder="To">
                                        <input type="text" id="mail-subject" placeholder="Subject">
                                        <textarea id="mail-body" rows="8" placeholder="Mail content"></textarea>
                                        <button id="send-mail-btn">Send</button>
                                    </div>
                                </div>
                                <div id="mail-view-single" style="display:none;">
                                    <h2 id="single-mail-subject" class="text-xl font-bold mb-2"></h2>
                                    <p class="text-sm text-gray-400 mb-2">From: <span id="single-mail-from"></span></p>
                                    <div id="single-mail-body" class="bg-gray-700 p-4 rounded-md overflow-y-auto max-h-80"></div>
                                    <button id="back-to-inbox-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md mt-4">Back to Inbox</button>
                                </div>
                            </div>
                        </div>
                    `;
                    newWindow = createWindow(appName, title, content, 800, 600);
                    if (newWindow) {
                        setupMailService(newWindow);
                    }
                    break;
                default:
                    title = 'Unknown Application';
                    content = '<p>This application is not yet implemented.</p>';
                    newWindow = createWindow(appName, title, content);
            }
        }

        dockedAppsState = Object.keys(applications).filter(appKey => applications[appKey].pinned);
        renderDock();

        function hideAllContextMenus() {
            desktopContextMenu.style.display = 'none';
            finderItemContextMenu.style.display = 'none';
            finderEmptyContextMenu.style.display = 'none';
            recycleBinItemContextMenu.style.display = 'none';
            dockItemContextMenu.style.display = 'none';
            windowContextMenu.style.display = 'none';
        }

        desktop.addEventListener('mousedown', (e) => {
            if (e.button === 0 && !e.target.closest('.desktop-icon') && !e.target.closest('.window')) {
                e.preventDefault();
                isSelecting = true;
                startSelectX = e.clientX;
                startSelectY = e.clientY;

                selectionBox = document.createElement('div');
                selectionBox.className = 'selection-box';
                desktop.appendChild(selectionBox);

                document.querySelectorAll('.desktop-icon.highlighted').forEach(icon => {
                    icon.classList.remove('highlighted');
                });
            }
        });

        desktop.addEventListener('mousemove', (e) => {
            if (!isSelecting) return;

            const currentX = e.clientX;
            const currentY = e.clientY;

            const left = Math.min(startSelectX, currentX);
            const top = Math.min(startSelectY, currentY);
            const width = Math.abs(startSelectX - currentX);
            const height = Math.abs(startSelectY - currentY);

            selectionBox.style.left = `${left}px`;
            selectionBox.style.top = `${top}px`;
            selectionBox.style.width = `${width}px`;
            selectionBox.style.height = `${height}px`;

            document.querySelectorAll('.desktop-icon').forEach(icon => {
                const iconRect = icon.getBoundingClientRect();
                const selectionRect = selectionBox.getBoundingClientRect();

                const intersects = !(iconRect.right < selectionRect.left ||
                                     iconRect.left > selectionRect.right ||
                                     iconRect.bottom < selectionRect.top ||
                                     iconRect.top > selectionRect.bottom);

                if (intersects) {
                    icon.classList.add('highlighted');
                } else {
                    icon.classList.remove('highlighted');
                }
            });
        });

        desktop.addEventListener('mouseup', (e) => {
            if (isSelecting) {
                isSelecting = false;
                if (selectionBox) {
                    selectionBox.remove();
                    selectionBox = null;
                }
            }
        });

        desktop.addEventListener('click', (e) => {
            if (!e.target.closest('.desktop-icon') && !e.target.closest('.window') && !e.target.closest('.selection-box')) {
                document.querySelectorAll('.desktop-icon.highlighted').forEach(icon => {
                    icon.classList.remove('highlighted');
                });
            }
        });

        desktop.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (e.dataTransfer.types.includes('text/plain')) {
                e.dataTransfer.dropEffect = 'move';
            }
        });

        desktop.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();

            const data = JSON.parse(e.dataTransfer.getData('text/plain'));
            const draggedItemPath = data.path;
            const draggedItemName = data.name;

            if (draggedItemPath) {
                handleFileMove(draggedItemPath, ['Desktop'], draggedItemName);
            }
        });


        desktop.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            hideAllContextMenus();
            desktopContextMenu.style.left = `${e.clientX}px`;
            desktopContextMenu.style.top = `${e.clientY}px`;
            desktopContextMenu.style.display = 'block';
        });

        document.addEventListener('click', (e) => {
            const isClickInsideContextMenu = desktopContextMenu.contains(e.target) ||
                                             finderItemContextMenu.contains(e.target) ||
                                             finderEmptyContextMenu.contains(e.target) ||
                                             recycleBinItemContextMenu.contains(e.target) ||
                                             dockItemContextMenu.contains(e.target) ||
                                             windowContextMenu.contains(e.target);

            if (e.button !== 2 && !isClickInsideContextMenu) {
                hideAllContextMenus();
                currentFinderContextItem = null;
                currentFinderWindowForContextMenu = null;
                currentDockContextItem = null;
                currentWindowForContextMenu = null;
                currentRecycleBinContextItem = null;
            }
        });

        function createNewFile(type, parentPath, defaultName, appName) {
            showCustomPrompt(`Enter name for new ${type} document:`, defaultName, (fileName) => {
                if (fileName) {
                    const targetFolder = traversePath(parentPath);
                    if (targetFolder && targetFolder.type === 'folder') {
                        if (!targetFolder.contents[fileName]) {
                            let initialContent = '';
                            if (type === 'word') initialContent = '<h1>New Document</h1><p>Start typing here...</p>';
                            if (type === 'powerpoint') initialContent = { slides: [{ content: '<h2>New Presentation</h2><p>Click to add text</p>' }] };
                            if (type === 'excel') initialContent = { cells: {} };
                            if (type === 'photo') initialContent = 'A new blank image file.';

                            targetFolder.contents[fileName] = { type: type, content: initialContent };
                            showCustomAlert(`New ${type} document "${fileName}" created.`);
                            initializeDesktopIcons();
                            updateFinderWindows(parentPath);
                            if (appName) {
                                launchApp(appName, fileName, initialContent, parentPath);
                            } else if (type === 'txt') {
                                launchApp('notepad', fileName, '', parentPath);
                            }
                        } else {
                            showCustomAlert('File already exists in this directory.', 'Creation Error');
                        }
                    }
                }
                hideAllContextMenus();
            });
        }

        desktopContextMenu.addEventListener('click', (e) => {
            const action = e.target.dataset.action;
            if (action) {
                switch (action) {
                    case 'new-folder':
                    case 'new-folder-submenu':
                        showCustomPrompt('Enter new folder name (on Desktop):', 'New Folder', (folderName) => {
                            if (folderName) {
                                const desktopFolder = traversePath(['Desktop']);
                                if (desktopFolder && desktopFolder.type === 'folder') {
                                    if (!desktopFolder.contents[folderName]) {
                                        desktopFolder.contents[folderName] = { type: 'folder', contents: {} };
                                        showCustomAlert(`New folder "${folderName}" created on Desktop.`);
                                        initializeDesktopIcons();
                                        openWindows['finder'].forEach(finderWin => {
                                            if (finderWin.style.display !== 'none' &&
                                                JSON.stringify(finderWin.currentPath) === JSON.stringify(['Desktop'])) {
                                                renderFinderContent(finderWin, finderWin.currentPath);
                                            }
                                        });
                                    } else {
                                        showCustomAlert('Folder already exists on Desktop.', 'Creation Error');
                                    }
                                }
                            }
                            hideAllContextMenus();
                        });
                        break;
                    case 'get-info':
                        showCustomAlert('Get Info functionality not yet implemented.', 'Info').then(() => {
                            hideAllContextMenus();
                        });
                        break;
                    case 'display-settings':
                        launchApp('settings');
                        hideAllContextMenus();
                        break;
                    case 'new-text-document':
                        createNewFile('txt', ['Desktop'], 'New Document.txt');
                        break;
                    case 'new-word-document':
                        createNewFile('word', ['Desktop'], 'New Document.docx', 'word');
                        break;
                    case 'new-powerpoint-presentation':
                        createNewFile('powerpoint', ['Desktop'], 'New Presentation.pptx', 'powerpoint');
                        break;
                    case 'new-excel-spreadsheet':
                        createNewFile('excel', ['Desktop'], 'New Spreadsheet.xlsx', 'excel');
                        break;
                }
            }
        });

        finderItemContextMenu.addEventListener('click', (e) => {
            const action = e.target.dataset.action;
            if (!currentFinderContextItem) return;

            const itemName = currentFinderContextItem.dataset.itemName;
            const itemType = currentFinderContextItem.dataset.itemType;
            const itemPathArray = JSON.parse(currentFinderContextItem.dataset.itemPath);
            const parentPathArray = itemPathArray.slice(0, -1);
            const parentFolder = traversePath(parentPathArray);

            if (!parentFolder || parentFolder.type !== 'folder' || !parentFolder.contents[itemName]) {
                showCustomAlert('Error: Item not found in file system.', 'File System Error').then(() => {
                    hideAllContextMenus();
                    currentFinderContextItem = null;
                });
                return;
            }

            switch (action) {
                case 'open':
                    if (itemType === 'folder') {
                        const newFinderWindow = createWindow('finder', 'Finder', `
                            <div class="flex h-full">
                                <div class="finder-sidebar">
                                    <h3 class="text-xs text-gray-400 uppercase mb-2">Favorites</h3>
                                    <div class="finder-sidebar-item flex items-center mb-1" data-path="Desktop">
                                        <i class="fas fa-desktop text-blue-400 mr-2"></i>
                                        <span>Desktop</span>
                                    </div>
                                    <div class="finder-sidebar-item flex items-center mb-1" data-path="Documents">
                                        <i class="fas fa-folder text-blue-400 mr-2"></i>
                                        <span>Documents</span>
                                    </div>
                                    <div class="finder-sidebar-item flex items-center mb-1" data-path="Downloads">
                                        <i class="fas fa-download text-blue-400 mr-2"></i>
                                        <span>Downloads</span>
                                    </div>
                                    <div class="finder-sidebar-item flex items-center mb-1" data-path="Applications">
                                        <i class="fas fa-star text-yellow-400 mr-2"></i>
                                        <span>Applications</span>
                                    </div>
                                    <div class="finder-sidebar-item flex items-center mb-1" data-path="Recycle Bin">
                                        <i class="fas fa-trash-alt text-gray-400 mr-2"></i>
                                        <span>Recycle Bin</span>
                                    </div>
                                </div>
                                <div class="flex flex-col flex-grow">
                                    <div class="finder-path-bar"></div>
                                    <div class="finder-main-content flex-grow overflow-y-auto">
                                    </div>
                                </div>
                            </div>
                        `, 800, 500);
                        newFinderWindow.currentPath = itemPathArray;
                        renderFinderContent(newFinderWindow, newFinderWindow.currentPath);
                    } else {
                        const fullPath = [...itemPathArray];
                        const fileContent = traversePath(fullPath).content;
                        const fileType = currentFinderContextItem.dataset.fileType;
                        switch (fileType) {
                            case 'txt':
                                let notepadWindow = createWindow('notepad', 'Notepad', getNotepadInitialContent(), 600, 400);
                                if (notepadWindow) {
                                    setupNotepad(notepadWindow);
                                    if (notepadWindow.notepadAPI && typeof notepadWindow.notepadAPI.addTab === 'function') {
                                        notepadWindow.notepadAPI.addTab(itemName, fileContent, parentPathArray);
                                    } else {
                                        showCustomAlert('Error: Notepad API not ready after setup.', 'Application Error');
                                    }
                                }
                                break;
                            case 'word':
                            case 'powerpoint':
                            case 'excel':
                            case 'photo':
                                launchApp(fileType, itemName, fileContent, parentPathArray);
                                break;
                            default:
                                showCustomAlert(`Cannot open file type: ${fileType}`, 'File Type Error');
                                break;
                        }
                    }
                    hideAllContextMenus();
                    currentFinderContextItem = null;
                    break;
                case 'rename':
                    showCustomPrompt(`Rename '${itemName}' to:`, itemName, (newName) => {
                        if (newName && newName !== itemName) {
                            if (parentFolder.contents[newName]) {
                                showCustomAlert(`An item named '${newName}' already exists.`, 'Rename Error');
                            } else {
                                parentFolder.contents[newName] = parentFolder.contents[itemName];
                                delete parentFolder.contents[itemName];
                                updateFinderWindows(parentPathArray);
                                initializeDesktopIcons();
                            }
                        } else if (newName !== null) {
                            showCustomAlert('Rename cancelled or no new name provided.', 'Rename Info');
                        }
                        hideAllContextMenus();
                        currentFinderContextItem = null;
                    }, 'Rename Item');
                    break;
                case 'delete':
                    showCustomConfirm(`Are you sure you want to move '${itemName}' to Recycle Bin?`, (confirmResult) => {
                        if (confirmResult) {
                            const itemToDelete = parentFolder.contents[itemName];
                            if (itemToDelete.type === 'folder' && Object.keys(itemToDelete.contents).length > 0) {
                                showCustomAlert(`Cannot delete non-empty folder '${itemName}'.`, 'Deletion Error');
                            } else {
                                const itemToRecycle = JSON.parse(JSON.stringify(itemToDelete));
                                itemToRecycle.originalPath = itemPathArray;

                                let recycleBinName = itemName;
                                let counter = 1;
                                while (fileSystem['Recycle Bin'].contents[recycleBinName]) {
                                    const nameParts = itemName.split('.');
                                    const baseName = nameParts[0];
                                    const extension = nameParts.length > 1 ? `.${nameParts.pop()}` : '';
                                    recycleBinName = `${baseName} (${counter})${extension}`;
                                    counter++;
                                }
                                fileSystem['Recycle Bin'].contents[recycleBinName] = itemToRecycle;
                                delete parentFolder.contents[itemName];

                                showCustomAlert(`'${itemName}' moved to Recycle Bin.`, 'Move to Recycle Bin Successful');
                                updateFinderWindows(parentPathArray);
                                initializeDesktopIcons();
                            }
                        } else {
                            showCustomAlert(`Deletion of '${itemName}' cancelled.`, 'Deletion Cancelled');
                        }
                        hideAllContextMenus();
                        currentFinderContextItem = null;
                    }, 'Confirm Deletion');
                    break;
                case 'open-in-terminal':
                    if (itemType === 'folder') {
                        const terminalWindow = launchApp('terminal');
                        if (terminalWindow && terminalWindow.setTerminalPath) {
                            terminalWindow.setTerminalPath(itemPathArray);
                        } else {
                            showCustomAlert('Error: Could not open terminal or set path.', 'Terminal Error');
                        }
                    } else {
                        showCustomAlert('Only folders can be opened in Terminal.', 'Terminal Error');
                    }
                    hideAllContextMenus();
                    currentFinderContextItem = null;
                    break;
            }
        });

        finderEmptyContextMenu.addEventListener('click', (e) => {
            const action = e.target.dataset.action;
            const targetFinderWindow = currentFinderWindowForContextMenu;

            if (!targetFinderWindow) {
                showCustomAlert('Error: No active Finder window for this action.', 'Creation Error').then(() => {
                    hideAllContextMenus();
                    currentFinderWindowForContextMenu = null;
                });
                return;
            }

            const currentPath = targetFinderWindow.currentPath;
            const currentFolder = traversePath(currentPath);

            if (!currentFolder || currentFolder.type !== 'folder') {
                showCustomAlert('Error: Cannot create items in this location.', 'Creation Error').then(() => {
                    hideAllContextMenus();
                    currentFinderWindowForContextMenu = null;
                });
                return;
            }

            switch (action) {
                case 'new-folder':
                case 'new-folder-submenu':
                    showCustomPrompt('Enter new folder name:', 'New Folder', (folderName) => {
                        if (folderName) {
                            if (!currentFolder.contents[folderName]) {
                                currentFolder.contents[folderName] = { type: 'folder', contents: {} };
                                showCustomAlert(`Folder "${folderName}" created.`, 'Creation Successful');
                                renderFinderContent(targetFinderWindow, currentPath);
                                if (JSON.stringify(currentPath) === JSON.stringify(['Desktop'])) {
                                    initializeDesktopIcons();
                                }
                            } else {
                                showCustomAlert('Folder already exists in this directory.', 'Creation Error');
                            }
                        }
                        hideAllContextMenus();
                        currentFinderWindowForContextMenu = null;
                    });
                    break;
                case 'new-text-document':
                    createNewFile('txt', currentPath, 'New Document.txt');
                    break;
                case 'new-word-document':
                    createNewFile('word', currentPath, 'New Document.docx', 'word');
                    break;
                case 'new-powerpoint-presentation':
                    createNewFile('powerpoint', currentPath, 'New Presentation.pptx', 'powerpoint');
                    break;
                case 'new-excel-spreadsheet':
                    createNewFile('excel', currentPath, 'New Spreadsheet.xlsx', 'excel');
                    break;
            }
        });

        recycleBinItemContextMenu.addEventListener('click', (e) => {
            const action = e.target.dataset.action;
            if (!currentRecycleBinContextItem) return;

            const itemName = currentRecycleBinContextItem.dataset.itemName;
            const itemPathArray = JSON.parse(currentRecycleBinContextItem.dataset.itemPath);
            const originalPathArray = JSON.parse(currentRecycleBinContextItem.dataset.originalPath);

            switch (action) {
                case 'restore':
                    showCustomConfirm(`Are you sure you want to restore '${itemName}' to its original location?`, (confirmResult) => {
                        if (confirmResult) {
                            const itemToRestore = fileSystem['Recycle Bin'].contents[itemName];
                            if (!itemToRestore) {
                                showCustomAlert('Error: Item not found in Recycle Bin.', 'Restore Error');
                                hideAllContextMenus();
                                currentRecycleBinContextItem = null;
                                return;
                            }

                            const originalParentPath = originalPathArray.slice(0, -1);
                            const originalParent = traversePath(originalParentPath);
                            const originalItemName = originalPathArray[originalPathArray.length - 1];

                            if (originalParent && originalParent.type === 'folder') {
                                if (originalParent.contents[originalItemName]) {
                                    showCustomAlert(`Cannot restore '${itemName}'. An item with the same name already exists in the original location.`, 'Restore Error');
                                } else {
                                    originalParent.contents[originalItemName] = itemToRestore;
                                    delete fileSystem['Recycle Bin'].contents[itemName];
                                    showCustomAlert(`'${itemName}' restored to ${originalParentPath.join('/') || 'koliteOS root'}.`, 'Restore Successful');
                                    updateFinderWindows(['Recycle Bin']);
                                    updateFinderWindows(originalParentPath);
                                    initializeDesktopIcons();
                                }
                            } else {
                                showCustomConfirm(`Original location not found. Restore '${itemName}' to Desktop instead?`, (confirmDesktop) => {
                                    if (confirmDesktop) {
                                        const desktopFolder = traversePath(['Desktop']);
                                        if (desktopFolder.contents[originalItemName]) {
                                            showCustomAlert(`Cannot restore '${itemName}'. An item with the same name already exists on Desktop.`, 'Restore Error');
                                        } else {
                                            desktopFolder.contents[originalItemName] = itemToRestore;
                                            delete fileSystem['Recycle Bin'].contents[itemName];
                                            showCustomAlert(`'${itemName}' restored to Desktop.`, 'Restore Successful');
                                            updateFinderWindows(['Recycle Bin']);
                                            updateFinderWindows(['Desktop']);
                                            initializeDesktopIcons();
                                        }
                                    } else {
                                        showCustomAlert(`Restore of '${itemName}' cancelled.`, 'Restore Cancelled');
                                    }
                                }, 'Restore to Desktop?');
                            }
                        } else {
                            showCustomAlert(`Restore of '${itemName}' cancelled.`, 'Restore Cancelled');
                        }
                        hideAllContextMenus();
                        currentRecycleBinContextItem = null;
                    }, 'Confirm Restore');
                    break;
                case 'delete-permanently':
                    showCustomConfirm(`Are you sure you want to PERMANENTLY delete '${itemName}'? This action cannot be undone.`, (confirmResult) => {
                        if (confirmResult) {
                            delete fileSystem['Recycle Bin'].contents[itemName];
                            showCustomAlert(`'${itemName}' permanently deleted.`, 'Deletion Successful');
                            updateFinderWindows(['Recycle Bin']);
                            initializeDesktopIcons();
                        } else {
                            showCustomAlert(`Permanent deletion of '${itemName}' cancelled.`, 'Deletion Cancelled');
                        }
                        hideAllContextMenus();
                        currentRecycleBinContextItem = null;
                    }, 'Confirm Permanent Deletion');
                    break;
            }
        });


        dockItemContextMenu.addEventListener('click', (e) => {
            const action = e.target.dataset.action;
            if (!currentDockContextItem) return;

            const appName = currentDockContextItem.dataset.app;

            switch (action) {
                case 'unpin-from-dock':
                    showCustomConfirm(`Are you sure you want to unpin '${applications[appName].name}' from the Dock?`, (confirmResult) => {
                        if (confirmResult) {
                            if (applications[appName]) {
                                applications[appName].pinned = false;
                                renderDock();
                                showCustomAlert(`'${applications[appName].name}' unpinned from Dock.`);
                            }
                        }
                        hideAllContextMenus();
                        currentDockContextItem = null;
                    }, 'Unpin from Dock');
                    break;
                case 'pin-to-dock':
                    showCustomConfirm(`Are you sure you want to pin '${applications[appName].name}' to the Dock?`, (confirmResult) => {
                        if (confirmResult) {
                            if (applications[appName]) {
                                applications[appName].pinned = true;
                                renderDock();
                                showCustomAlert(`'${applications[appName].name}' pinned to Dock.`);
                            }
                        }
                        hideAllContextMenus();
                        currentDockContextItem = null;
                    }, 'Pin to Dock');
                    break;
            }
        });

        windowContextMenu.addEventListener('click', (e) => {
            const action = e.target.dataset.action;
            if (!currentWindowForContextMenu) return;

            switch (action) {
                case 'close-window':
                    currentWindowForContextMenu.querySelector('.close-btn').click();
                    break;
                case 'minimize-window':
                    currentWindowForContextMenu.querySelector('.minimize-btn').click();
                    break;
                case 'maximize-window':
                    currentWindowForContextMenu.querySelector('.maximize-btn').click();
                    break;
            }
            hideAllContextMenus();
            currentWindowForContextMenu = null;
        });


        function showSearchModal() {
            searchModalOverlay.style.display = 'flex';
            searchInput.value = '';
            searchResultsContainer.innerHTML = '';
            searchInput.focus();
            searchModalOverlay.classList.toggle('light', body.classList.contains('theme-light'));
        }

        function hideSearchModal() {
            searchModalOverlay.style.display = 'none';
        }

        function searchFileSystem(query, currentPath, currentContents, results) {
            for (const itemName in currentContents) {
                const item = currentContents[itemName];
                const fullPath = [...currentPath, itemName];

                if (itemName.toLowerCase().includes(query.toLowerCase())) {
                    results.push({
                        name: itemName,
                        type: item.type,
                        path: fullPath
                    });
                }

                if (item.type === 'folder' && item.contents) {
                    searchFileSystem(query, fullPath, item.contents, results);
                }
            }
        }

        function performSearch(query) {
            searchResultsContainer.innerHTML = '';
            if (query.trim() === '') {
                return;
            }

            const results = [];
            for (const appKey in applications) {
                const app = applications[appKey];
                if (app.name.toLowerCase().includes(query.toLowerCase())) {
                    results.push({
                        name: app.name,
                        type: 'app',
                        appName: appKey,
                        icon: app.icon
                    });
                }
            }

            searchFileSystem(query, [], fileSystem, results);

            renderSearchResults(results);
        }

        function renderSearchResults(results) {
            searchResultsContainer.innerHTML = '';
            if (results.length === 0) {
                const noResults = document.createElement('div');
                noResults.className = 'text-center text-gray-400 p-4';
                noResults.textContent = 'No results found.';
                searchResultsContainer.appendChild(noResults);
                return;
            }

            results.forEach(result => {
                const resultItem = document.createElement('div');
                resultItem.className = 'search-result-item';
                
                let iconHtml = '';
                if (result.icon && (result.icon.startsWith('fas ') || result.icon.startsWith('fab '))) {
                    iconHtml = `<i class="${result.icon}"></i>`;
                } else if (result.icon) {
                    iconHtml = `<img src="${result.icon}" alt="${result.name}" class="w-5 h-5">`;
                } else {
                    switch (result.type) {
                        case 'folder': iconHtml = `<i class="fas fa-folder"></i>`; break;
                        case 'txt': iconHtml = `<i class="fas fa-file-alt"></i>`; break;
                        case 'word': iconHtml = `<i class="fas fa-file-word text-blue-500"></i>`; break;
                        case 'powerpoint': iconHtml = `<i class="fas fa-file-powerpoint text-red-500"></i>`; break;
                        case 'excel': iconHtml = `<i class="fas fa-file-excel text-green-500"></i>`; break;
                        case 'photo': iconHtml = `<i class="fas fa-image text-purple-500"></i>`; break;
                        default: iconHtml = `<i class="fas fa-file"></i>`; break;
                    }
                }

                resultItem.innerHTML = `
                    ${iconHtml}
                    <span>${result.name}</span>
                    <small>${result.type === 'folder' ? 'Folder' : result.type === 'file' ? 'File' : 'Application'}</small>
                `;
                resultItem.dataset.itemType = result.type;
                resultItem.dataset.itemName = result.name;
                if (result.type === 'app') {
                    resultItem.dataset.appName = result.appName;
                } else {
                    resultItem.dataset.itemPath = JSON.stringify(result.path);
                    resultItem.dataset.fileType = result.type;
                }

                resultItem.addEventListener('click', (e) => {
                    const type = e.currentTarget.dataset.itemType;
                    const name = e.currentTarget.dataset.itemName;
                    
                    hideSearchModal();

                    if (type === 'folder') {
                        const path = JSON.parse(e.currentTarget.dataset.itemPath);
                        const newFinderWindow = createWindow('finder', 'Finder', `
                            <div class="flex h-full">
                                <div class="finder-sidebar">
                                    <h3 class="text-xs text-gray-400 uppercase mb-2">Favorites</h3>
                                    <div class="finder-sidebar-item flex items-center mb-1" data-path="Desktop">
                                        <i class="fas fa-desktop text-blue-400 mr-2"></i>
                                        <span>Desktop</span>
                                    </div>
                                    <div class="finder-sidebar-item flex items-center mb-1" data-path="Documents">
                                        <i class="fas fa-folder text-blue-400 mr-2"></i>
                                        <span>Documents</span>
                                    </div>
                                    <div class="finder-sidebar-item flex items-center mb-1" data-path="Downloads">
                                        <i class="fas fa-download text-blue-400 mr-2"></i>
                                        <span>Downloads</span>
                                    </div>
                                    <div class="finder-sidebar-item flex items-center mb-1" data-path="Applications">
                                        <i class="fas fa-star text-yellow-400 mr-2"></i>
                                        <span>Applications</span>
                                    </div>
                                    <div class="finder-sidebar-item flex items-center mb-1" data-path="Recycle Bin">
                                        <i class="fas fa-trash-alt text-gray-400 mr-2"></i>
                                        <span>Recycle Bin</span>
                                    </div>
                                </div>
                                <div class="flex flex-col flex-grow">
                                    <div class="finder-path-bar"></div>
                                    <div class="finder-main-content flex-grow overflow-y-auto">
                                    </div>
                                </div>
                            </div>
                        `, 800, 500);
                        if (newFinderWindow) {
                            newFinderWindow.currentPath = path;
                            renderFinderContent(newFinderWindow, newFinderWindow.currentPath);
                            newFinderWindow.querySelectorAll('.finder-sidebar-item').forEach(item => {
                                item.addEventListener('click', (e) => {
                                    const targetPath = e.currentTarget.dataset.path;
                                    newFinderWindow.currentPath = [targetPath];
                                    renderFinderContent(newFinderWindow, newFinderWindow.currentPath);
                                });
                            });
                        }
                    } else if (type === 'file' || type === 'txt' || type === 'word' || type === 'powerpoint' || type === 'excel' || type === 'photo') {
                        const path = JSON.parse(e.currentTarget.dataset.itemPath);
                        const fileContent = traversePath(path).content;
                        const fileType = e.currentTarget.dataset.fileType;

                        switch (fileType) {
                            case 'txt':
                                let notepadWindow = createWindow('notepad', 'Notepad', getNotepadInitialContent(), 600, 400);
                                if (notepadWindow) {
                                    setupNotepad(notepadWindow);
                                    if (notepadWindow.notepadAPI && typeof notepadWindow.notepadAPI.addTab === 'function') {
                                        notepadWindow.notepadAPI.addTab(name, fileContent, path.slice(0, -1));
                                    } else {
                                        showCustomAlert('Error: Notepad API not ready after setup.', 'Application Error');
                                    }
                                }
                                break;
                            case 'word':
                            case 'powerpoint':
                            case 'excel':
                            case 'photo':
                                launchApp(fileType, name, fileContent, path.slice(0, -1));
                                break;
                            default:
                                showCustomAlert(`Cannot open file type: ${fileType}`, 'File Type Error');
                                break;
                        }
                    } else if (type === 'app') {
                        const appToOpen = e.currentTarget.dataset.appName;
                        launchApp(appToOpen);
                    }
                });
                searchResultsContainer.appendChild(resultItem);
            });
        }

        searchButton.addEventListener('click', showSearchModal);

        searchInput.addEventListener('input', (e) => {
            performSearch(e.target.value);
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && searchModalOverlay.style.display === 'flex') {
                hideSearchModal();
            }
        });

        searchModalOverlay.addEventListener('click', (e) => {
            if (e.target === searchModalOverlay) {
                hideSearchModal();
            }
        });

        fullscreenToggle.addEventListener('click', () => {
            if (document.fullscreenElement) {
                document.exitFullscreen();
                fullscreenToggle.classList.remove('fa-compress');
                fullscreenToggle.classList.add('fa-expand');
            } else {
                document.documentElement.requestFullscreen().catch(err => {
                    showCustomAlert(`Error attempting to enable full-screen mode: ${err.message} (You might need to interact with the page first or your browser may restrict it).`, 'Fullscreen Error');
                });
                fullscreenToggle.classList.remove('fa-expand');
                fullscreenToggle.classList.add('fa-compress');
            }
        });

        document.addEventListener('fullscreenchange', () => {
            if (document.fullscreenElement) {
                fullscreenToggle.classList.remove('fa-expand');
                fullscreenToggle.classList.add('fa-compress');
            } else {
                fullscreenToggle.classList.remove('fa-compress');
                fullscreenToggle.classList.add('fa-expand');
            }
        });

        let currentVolume = 50;

        volumeSlider.value = currentVolume;
        volumePercentage.textContent = `${currentVolume}%`;

        volumeButton.addEventListener('click', (e) => {
            e.stopPropagation();
            if (volumeSliderContainer.style.display === 'flex') {
                volumeSliderContainer.style.display = 'none';
            } else {
                volumeSliderContainer.style.display = 'flex';
                const volumeButtonRect = volumeButton.getBoundingClientRect();
                volumeSliderContainer.style.left = `${volumeButtonRect.right - volumeSliderContainer.offsetWidth}px`;
                volumeSliderContainer.style.top = `${volumeButtonRect.bottom + 5}px`;
                volumeSliderContainer.classList.toggle('light', body.classList.contains('theme-light'));
            }
        });

        volumeSlider.addEventListener('input', (e) => {
            currentVolume = e.target.value;
            volumePercentage.textContent = `${currentVolume}%`;
        });

        document.addEventListener('click', (e) => {
            const isClickInsideVolumeControls = volumeButton.contains(e.target) || volumeSliderContainer.contains(e.target);
            if (!isClickInsideVolumeControls && volumeSliderContainer.style.display === 'flex') {
                volumeSliderContainer.style.display = 'none';
            }
        });

        function setupPaint(windowElement) {
            const canvas = windowElement.querySelector('#paint-canvas');
            const ctx = canvas.getContext('2d');
            const colorPicker = windowElement.querySelector('#color-picker');
            const brushSize = windowElement.querySelector('#brush-size');
            const clearButton = windowElement.querySelector('#clear-canvas');

            let drawing = false;
            let currentColor = colorPicker.value;
            let currentBrushSize = brushSize.value;

            function startDrawing(e) {
                drawing = true;
                draw(e);
            }

            function stopDrawing() {
                drawing = false;
                ctx.beginPath();
            }

            function draw(e) {
                if (!drawing) return;

                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX || e.touches[0].clientX) - rect.left;
                const y = (e.clientY || e.touches[0].clientY) - rect.top;

                ctx.lineWidth = currentBrushSize;
                ctx.lineCap = 'round';
                ctx.strokeStyle = currentColor;

                ctx.lineTo(x, y);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(x, y);
            }

            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mousemove', draw);

            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                startDrawing(e);
            });
            canvas.addEventListener('touchend', stopDrawing);
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                draw(e);
            });

            colorPicker.addEventListener('input', (e) => {
                currentColor = e.target.value;
            });

            brushSize.addEventListener('input', (e) => {
                currentBrushSize = e.target.value;
            });

            clearButton.addEventListener('click', () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            });

            function resizeCanvas() {
                const parent = canvas.parentElement;
                canvas.width = parent.clientWidth - 32;
                canvas.height = parent.clientHeight - 100;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            windowElement.addEventListener('resize', resizeCanvas);
        }

        function setupTicTacToe(windowElement) {
            const cells = windowElement.querySelectorAll('.tic-tac-toe-cell');
            const messageDisplay = windowElement.querySelector('#tic-tac-toe-message');
            const resetButton = windowElement.querySelector('#tic-tac-toe-reset');
            let board = ['', '', '', '', '', '', '', '', ''];
            let currentPlayer = 'X';
            let isGameActive = true;

            const winningConditions = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8],
                [0, 3, 6], [1, 4, 7], [2, 5, 8],
                [0, 4, 8], [2, 4, 6]
            ];

            function handleCellClick(e) {
                const clickedCell = e.target;
                const clickedCellIndex = parseInt(clickedCell.dataset.cellIndex);

                if (board[clickedCellIndex] !== '' || !isGameActive) {
                    return;
                }

                board[clickedCellIndex] = currentPlayer;
                clickedCell.textContent = currentPlayer;
                clickedCell.classList.add(currentPlayer);
                checkResult();
            }

            function checkResult() {
                let roundWon = false;
                for (let i = 0; i < winningConditions.length; i++) {
                    const winCondition = winningConditions[i];
                    let a = board[winCondition[0]];
                    let b = board[winCondition[1]];
                    let c = board[winCondition[2]];

                    if (a === '' || b === '' || c === '') {
                        continue;
                    }
                    if (a === b && b === c) {
                        roundWon = true;
                        break;
                    }
                }

                if (roundWon) {
                    messageDisplay.textContent = `Player ${currentPlayer} Wins!`;
                    isGameActive = false;
                    return;
                }

                let roundDraw = !board.includes('');
                if (roundDraw) {
                    messageDisplay.textContent = 'It\'s a Draw!';
                    isGameActive = false;
                    return;
                }

                currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
                messageDisplay.textContent = `Player ${currentPlayer}'s Turn`;
            }

            function resetGame() {
                board = ['', '', '', '', '', '', '', '', ''];
                currentPlayer = 'X';
                isGameActive = true;
                messageDisplay.textContent = `Player ${currentPlayer}'s Turn`;
                cells.forEach(cell => {
                    cell.textContent = '';
                    cell.classList.remove('X', 'O');
                });
            }

            cells.forEach(cell => cell.addEventListener('click', handleCellClick));
            resetButton.addEventListener('click', resetGame);
        }

        function setupSnakeGame(windowElement) {
            const canvas = windowElement.querySelector('#snake-game-canvas');
            const ctx = canvas.getContext('2d');
            const scoreDisplay = windowElement.querySelector('#snake-score');
            const startButton = windowElement.querySelector('#snake-start-btn');

            const gridSize = 20;
            let snake = [{ x: 10, y: 10 }];
            let food = {};
            let direction = 'right';
            let score = 0;
            let gameInterval;
            let gameSpeed = 150;
            let isGameRunning = false;

            function generateFood() {
                food = {
                    x: Math.floor(Math.random() * (canvas.width / gridSize)),
                    y: Math.floor(Math.random() * (canvas.height / gridSize))
                };
            }

            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                ctx.fillStyle = 'lime';
                snake.forEach(segment => {
                    ctx.fillRect(segment.x * gridSize, segment.y * gridSize, gridSize, gridSize);
                });

                ctx.fillStyle = 'red';
                ctx.fillRect(food.x * gridSize, food.y * gridSize, gridSize, gridSize);
            }

            function update() {
                if (!isGameRunning) return;

                const head = { x: snake[0].x, y: snake[0].y };

                switch (direction) {
                    case 'up': head.y--; break;
                    case 'down': head.y++; break;
                    case 'left': head.x--; break;
                    case 'right': head.x++; break;
                }

                if (head.x < 0 || head.x >= canvas.width / gridSize ||
                    head.y < 0 || head.y >= canvas.height / gridSize ||
                    checkCollision(head)) {
                    endGame();
                    return;
                }

                snake.unshift(head);

                if (head.x === food.x && head.y === food.y) {
                    score++;
                    scoreDisplay.textContent = `Score: ${score}`;
                    generateFood();
                    gameSpeed = Math.max(50, gameSpeed - 5);
                    clearInterval(gameInterval);
                    gameInterval = setInterval(update, gameSpeed);
                } else {
                    snake.pop();
                }

                draw();
            }

            function checkCollision(head) {
                for (let i = 1; i < snake.length; i++) {
                    if (head.x === snake[i].x && head.y === snake[i].y) {
                        return true;
                    }
                }
                return false;
            }

            function endGame() {
                isGameRunning = false;
                clearInterval(gameInterval);
                showCustomAlert(`Game Over! Your score: ${score}`, 'Snake Game');
                startButton.disabled = false;
            }

            function handleKeyPress(e) {
                const keyPressed = e.key;
                if (['ArrowUp', 'w', 'W'].includes(keyPressed) && direction !== 'down') direction = 'up';
                if (['ArrowDown', 's', 'S'].includes(keyPressed) && direction !== 'up') direction = 'down';
                if (['ArrowLeft', 'a', 'A'].includes(keyPressed) && direction !== 'right') direction = 'left';
                if (['ArrowRight', 'd', 'D'].includes(keyPressed) && direction !== 'left') direction = 'right';
            }

            function startGameLoop() {
                snake = [{ x: 10, y: 10 }];
                direction = 'right';
                score = 0;
                gameSpeed = 150;
                scoreDisplay.textContent = `Score: ${score}`;
                generateFood();
                draw();
                isGameRunning = true;
                startButton.disabled = true;
                clearInterval(gameInterval);
                gameInterval = setInterval(update, gameSpeed);
            }

            startButton.addEventListener('click', startGameLoop);
            windowElement.addEventListener('keydown', handleKeyPress);

            windowElement.addEventListener('remove', () => {
                clearInterval(gameInterval);
                windowElement.removeEventListener('keydown', handleKeyPress);
            });
        }

        function setupYouTubePlayer(windowElement) {
            const urlInput = windowElement.querySelector('#youtube-url-input');
            const loadButton = windowElement.querySelector('#youtube-load-btn');
            const iframe = windowElement.querySelector('#youtube-iframe');

            function loadVideo() {
                let url = urlInput.value.trim();
                let videoId = '';

                if (url.includes('youtube.com/watch?v=')) {
                    videoId = url.split('v=')[1];
                    const ampersandPosition = videoId.indexOf('&');
                    if (ampersandPosition !== -1) {
                        videoId = videoId.substring(0, ampersandPosition);
                    }
                } else if (url.includes('youtu.be/')) {
                    videoId = url.split('youtu.be/')[1];
                    const questionMarkPosition = videoId.indexOf('?');
                    if (questionMarkPosition !== -1) {
                        videoId = videoId.substring(0, questionMarkPosition);
                    }
                } else {
                    videoId = url;
                }

                if (videoId) {
                    iframe.src = `https://www.youtube.com/embed/${videoId}`;
                } else {
                    showCustomAlert('Please enter a valid YouTube URL or video ID.', 'Invalid URL');
                    iframe.src = 'about:blank';
                }
            }

            loadButton.addEventListener('click', loadVideo);
            urlInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    loadVideo();
                }
            });
        }

        function setupBrowser(windowElement) {
            const addressInput = windowElement.querySelector('#browser-address-input');
            const goButton = windowElement.querySelector('#browser-go-btn');
            const iframe = windowElement.querySelector('#browser-iframe');

            function navigate() {
                let url = addressInput.value.trim();
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    url = 'https://' + url;
                }
                try {
                    iframe.src = url;
                } catch (error) {
                    showCustomAlert(`Could not load URL: ${url}. Browsers often block embedding of external websites due to security policies (X-Frame-Options).`, 'Browser Error');
                    iframe.src = 'about:blank';
                }
            }

            goButton.addEventListener('click', navigate);
            addressInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    navigate();
                }
            });

            iframe.addEventListener('load', () => {
                try {
                    addressInput.value = iframe.contentWindow.location.href;
                } catch (e) {
                    addressInput.value = iframe.src;
                }
            });
        }

        function setupXenosAI(windowElement) {
            const outputDiv = windowElement.querySelector('#xenosai-output');
            const inputField = windowElement.querySelector('#xenosai-input');
            const sendButton = windowElement.querySelector('#xenosai-send-btn');

            const appendMessage = (sender, message, isUser = false) => {
                const p = document.createElement('p');
                p.classList.add(isUser ? 'text-white' : 'text-blue-400');
                p.innerHTML = `<strong>${sender}:</strong> ${message}`;
                outputDiv.appendChild(p);
                outputDiv.scrollTop = outputDiv.scrollHeight;
            };

            const processCommand = (command) => {
                const lowerCommand = command.toLowerCase().trim();

                if (lowerCommand.startsWith('open ')) {
                    const appNameQuery = lowerCommand.substring(5).trim();
                    const foundAppKey = Object.keys(applications).find(key => 
                        applications[key].name.toLowerCase() === appNameQuery || key === appNameQuery
                    );

                    if (foundAppKey) {
                        appendMessage('XenosAI', `Opening ${applications[foundAppKey].name}...`);
                        launchApp(foundAppKey);
                    } else {
                        appendMessage('XenosAI', `Sorry, I couldn't find an app named "${appNameQuery}".`);
                    }
                } else if (lowerCommand.includes('hello') || lowerCommand.includes('hi')) {
                    appendMessage('XenosAI', 'Hello there! How can I assist you?');
                } else if (lowerCommand.includes('time')) {
                    appendMessage('XenosAI', `The current time is ${currentTimeSpan.textContent}.`);
                } else if (lowerCommand.includes('date')) {
                    appendMessage('XenosAI', `Today's date is ${currentDateSpan.textContent}.`);
                } else if (lowerCommand.includes('how are you')) {
                    appendMessage('XenosAI', 'I am a web-based AI assistant, functioning perfectly!');
                } else if (lowerCommand.includes('what is koliteos')) {
                    appendMessage('XenosAI', 'koliteOS is a web-based operating system built by Dakshit Singh, and consist of 6164 lines of code.');
                } else {
                    appendMessage('XenosAI', `I don't understand that command. Try "Open {appname}" or ask me about time/date.`);
                }
            };

            sendButton.addEventListener('click', () => {
                const command = inputField.value;
                if (command.trim() === '') return;
                appendMessage('You', command, true);
                inputField.value = '';
                processCommand(command);
            });

            inputField.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    sendButton.click();
                }
            });
        }

        const musicTracks = [
            { title: 'BLAH!', artist: 'Artist A', duration: 30, notes: ['C4', 'E4', 'G4', 'C5', 'G4', 'E4', 'C4'] },
            { title: 'Montagem Tomada', artist: 'Artist B', duration: 45, notes: ['D4', 'F4', 'A4', 'D5', 'A4', 'F4', 'D4'] },
            { title: 'FUNK ESTRELAS', artist: 'Artist C', duration: 60, notes: ['E4', 'G#4', 'B4', 'E5', 'B4', 'G#4', 'E4'] },
            { title: 'LOKA DEMAIS', artist: 'Artist D', duration: 50, notes: ['F4', 'A4', 'C5', 'F5', 'C5', 'A4', 'F4'] }
        ];

        let currentTrackIndex = 0;
        let playerSynth = null;
        let isPlaying = false;
        let loopId = null;

        function setupMusicPlayer(windowElement) {
            const albumArt = windowElement.querySelector('#album-art');
            const trackTitle = windowElement.querySelector('#track-title');
            const trackArtist = windowElement.querySelector('#track-artist');
            const currentTimeDisplay = windowElement.querySelector('#current-time-display');
            const durationDisplay = windowElement.querySelector('#duration-display');
            const musicProgress = windowElement.querySelector('#music-progress');
            const prevBtn = windowElement.querySelector('#prev-btn');
            const playPauseBtn = windowElement.querySelector('#play-pause-btn');
            const nextBtn = windowElement.querySelector('#next-btn');
            const playlistUl = windowElement.querySelector('#playlist');
            const playPauseIcon = playPauseBtn.querySelector('i');

            Tone.start();
            playerSynth = new Tone.Synth().toDestination();

            function formatTime(seconds) {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = Math.floor(seconds % 60);
                return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
            }

            function loadTrack(index) {
                if (playerSynth) {
                    Tone.Transport.stop();
                    Tone.Transport.clear(loopId);
                }
                currentTrackIndex = index;
                const track = musicTracks[currentTrackIndex];
                trackTitle.textContent = track.title;
                trackArtist.textContent = track.artist;
                durationDisplay.textContent = formatTime(track.duration);
                musicProgress.max = track.duration;
                musicProgress.value = 0;
                currentTimeDisplay.textContent = '0:00';
                albumArt.src = `https://placehold.co/150x150/333333/FFFFFF?text=${track.title.replace(/ /g, '+')}`;
                
                renderPlaylist();
            }

            function playTrack() {
                if (isPlaying) {
                    Tone.Transport.pause();
                    isPlaying = false;
                    playPauseIcon.classList.remove('fa-pause');
                    playPauseIcon.classList.add('fa-play');
                    musicWaveIndicator.style.display = 'none';
                } else {
                    Tone.Transport.start();
                    isPlaying = true;
                    playPauseIcon.classList.remove('fa-play');
                    playPauseIcon.classList.add('fa-pause');
                    musicWaveIndicator.style.display = 'flex';
                }
            }

            function playCurrentTrackNotes() {
                const track = musicTracks[currentTrackIndex];
                let time = Tone.Transport.now();
                track.notes.forEach((note, index) => {
                    playerSynth.triggerAttackRelease(note, '8n', time + (index * 0.5));
                });
            }

            function nextTrack() {
                loadTrack((currentTrackIndex + 1) % musicTracks.length);
                playCurrentTrackNotes();
                Tone.Transport.start();
            }

            function prevTrack() {
                loadTrack((currentTrackIndex - 1 + musicTracks.length) % musicTracks.length);
                playCurrentTrackNotes();
                Tone.Transport.start();
            }

            function renderPlaylist() {
                playlistUl.innerHTML = '';
                musicTracks.forEach((track, index) => {
                    const li = document.createElement('li');
                    li.className = `p-2 cursor-pointer hover:bg-gray-600 ${index === currentTrackIndex ? 'bg-blue-800' : ''}`;
                    li.textContent = `${track.title} - ${track.artist}`;
                    li.dataset.index = index;
                    li.addEventListener('click', () => {
                        loadTrack(index);
                        playCurrentTrackNotes();
                        Tone.Transport.start();
                        isPlaying = true;
                        playPauseIcon.classList.remove('fa-play');
                        playPauseIcon.classList.add('fa-pause');
                        musicWaveIndicator.style.display = 'flex';
                    });
                    playlistUl.appendChild(li);
                });
            }

            Tone.Transport.scheduleRepeat((time) => {
                if (isPlaying) {
                    playCurrentTrackNotes();
                }
            }, "2n");

            Tone.Transport.on('start', () => {
                isPlaying = true;
                musicWaveIndicator.style.display = 'flex';
            });
            Tone.Transport.on('pause', () => {
                isPlaying = false;
                musicWaveIndicator.style.display = 'none';
            });
            Tone.Transport.on('stop', () => {
                isPlaying = false;
                musicWaveIndicator.style.display = 'none';
                musicProgress.value = 0;
                currentTimeDisplay.textContent = '0:00';
            });

            Tone.Transport.scheduleRepeat(() => {
                if (isPlaying) {
                    const progress = Tone.Transport.seconds % musicTracks[currentTrackIndex].duration;
                    musicProgress.value = progress;
                    currentTimeDisplay.textContent = formatTime(progress);
                    if (progress >= musicTracks[currentTrackIndex].duration - 0.1) {
                        nextTrack();
                    }
                }
            }, 0.1);

            playPauseBtn.addEventListener('click', playTrack);
            nextBtn.addEventListener('click', nextTrack);
            prevBtn.addEventListener('click', prevTrack);

            musicProgress.addEventListener('input', (e) => {
                Tone.Transport.seconds = parseFloat(e.target.value);
            });

            loadTrack(currentTrackIndex);

            windowElement.addEventListener('remove', () => {
                if (playerSynth) {
                    Tone.Transport.stop();
                    Tone.Transport.clear(loopId);
                    playerSynth.dispose();
                    musicWaveIndicator.style.display = 'none';
                }
            });
        }

        let calculatorDisplayValue = '0';
        let firstOperand = null;
        let operator = null;
        let waitingForSecondOperand = false;

        function setupCalculator(windowElement) {
            const display = windowElement.querySelector('#calculator-display');
            const buttons = windowElement.querySelectorAll('.calculator-button');

            function updateDisplay() {
                display.textContent = calculatorDisplayValue;
            }

            function inputDigit(digit) {
                if (waitingForSecondOperand) {
                    calculatorDisplayValue = digit;
                    waitingForSecondOperand = false;
                } else {
                    calculatorDisplayValue = calculatorDisplayValue === '0' ? digit : calculatorDisplayValue + digit;
                }
                updateDisplay();
            }

            function inputDecimal() {
                if (!calculatorDisplayValue.includes('.')) {
                    calculatorDisplayValue += '.';
                }
                updateDisplay();
            }

            function clearCalculator() {
                calculatorDisplayValue = '0';
                firstOperand = null;
                operator = null;
                waitingForSecondOperand = false;
                updateDisplay();
            }

            function handleOperator(nextOperator) {
                const inputValue = parseFloat(calculatorDisplayValue);

                if (operator && waitingForSecondOperand) {
                    operator = nextOperator;
                    return;
                }

                if (firstOperand === null) {
                    firstOperand = inputValue;
                } else if (operator) {
                    const result = performCalculation[operator](firstOperand, inputValue);
                    calculatorDisplayValue = String(result);
                    firstOperand = result;
                }

                waitingForSecondOperand = true;
                operator = nextOperator;
                updateDisplay();
            }

            const performCalculation = {
                '/': (first, second) => first / second,
                '*': (first, second) => first * second,
                '+': (first, second) => first + second,
                '-': (first, second) => first - second,
                '=': (first, second) => second
            };

            buttons.forEach(button => {
                button.addEventListener('click', (e) => {
                    const action = e.target.dataset.action;
                    if (!isNaN(parseInt(action))) {
                        inputDigit(action);
                    } else if (action === 'decimal') {
                        inputDecimal();
                    } else if (action === 'clear') {
                        clearCalculator();
                    } else if (action === 'negate') {
                        calculatorDisplayValue = String(parseFloat(calculatorDisplayValue) * -1);
                        updateDisplay();
                    } else if (action === 'percent') {
                        calculatorDisplayValue = String(parseFloat(calculatorDisplayValue) / 100);
                        updateDisplay();
                    } else {
                        handleOperator(action);
                    }
                });
            });

            updateDisplay();
        }

        let mailInbox = [
            { from: 'support@koliteos.com', subject: 'Welcome to KoliteOS Mail!', body: 'Thank you for trying out our mail service. This is a simulated email client.' },
            { from: 'dev@koliteos.com', subject: 'New Features Coming Soon!', body: 'Stay tuned for exciting new updates to KoliteOS!' }
        ];
        let mailSent = [];

        function setupMailService(windowElement) {
            const composeBtn = windowElement.querySelector('#compose-mail-btn');
            const inboxView = windowElement.querySelector('#mail-inbox-view');
            const sentView = windowElement.querySelector('#mail-sent-view');
            const composeView = windowElement.querySelector('#mail-compose-view');
            const singleMailView = windowElement.querySelector('#mail-view-single');
            const inboxList = windowElement.querySelector('#inbox-list');
            const sentList = windowElement.querySelector('#sent-list');
            const mailToInput = windowElement.querySelector('#mail-to');
            const mailSubjectInput = windowElement.querySelector('#mail-subject');
            const mailBodyTextarea = windowElement.querySelector('#mail-body');
            const sendMailBtn = windowElement.querySelector('#send-mail-btn');
            const singleMailSubject = windowElement.querySelector('#single-mail-subject');
            const singleMailFrom = windowElement.querySelector('#single-mail-from');
            const singleMailBody = windowElement.querySelector('#single-mail-body');
            const backToInboxBtn = windowElement.querySelector('#back-to-inbox-btn');
            const sidebarItems = windowElement.querySelectorAll('.mail-sidebar-item');

            function showView(viewId) {
                inboxView.style.display = 'none';
                sentView.style.display = 'none';
                composeView.style.display = 'none';
                singleMailView.style.display = 'none';

                windowElement.querySelector(`#${viewId}`).style.display = 'block';

                sidebarItems.forEach(item => item.classList.remove('active'));
                const activeSidebarItem = windowElement.querySelector(`.mail-sidebar-item[data-view="${viewId.replace('mail-', '').replace('-view', '')}"]`);
                if (activeSidebarItem) {
                    activeSidebarItem.classList.add('active');
                }
            }

            function renderMailList(list, container) {
                container.innerHTML = '';
                if (list.length === 0) {
                    container.innerHTML = '<p class="text-gray-400">No mail in this folder.</p>';
                    return;
                }
                list.forEach((mail, index) => {
                    const mailItem = document.createElement('div');
                    mailItem.className = 'mail-list-item';
                    mailItem.innerHTML = `
                        <p class="font-semibold">${mail.subject}</p>
                        <p class="text-sm text-gray-400">From: ${mail.from}</p>
                    `;
                    mailItem.addEventListener('click', () => {
                        singleMailSubject.textContent = mail.subject;
                        singleMailFrom.textContent = mail.from;
                        singleMailBody.textContent = mail.body;
                        showView('mail-view-single');
                    });
                    container.appendChild(mailItem);
                });
            }

            composeBtn.addEventListener('click', () => {
                mailToInput.value = '';
                mailSubjectInput.value = '';
                mailBodyTextarea.value = '';
                showView('mail-compose-view');
            });

            sendMailBtn.addEventListener('click', () => {
                const to = mailToInput.value.trim();
                const subject = mailSubjectInput.value.trim();
                const body = mailBodyTextarea.value.trim();

                if (to && subject && body) {
                    const newMail = { from: 'me@koliteos.com', to, subject, body };
                    mailSent.push(newMail);
                    showNotification('Mail sent successfully!', 'success', 'Mail');
                    showView('mail-inbox-view');
                    renderMailList(mailInbox, inboxList);
                    renderMailList(mailSent, sentList);
                } else {
                    showCustomAlert('Please fill in all fields (To, Subject, Body).', 'Send Mail Error');
                }
            });

            backToInboxBtn.addEventListener('click', () => {
                showView('mail-inbox-view');
            });

            sidebarItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    const view = e.currentTarget.dataset.view;
                    showView(`mail-${view}-view`);
                });
            });

            renderMailList(mailInbox, inboxList);
            renderMailList(mailSent, sentList);
            showView('mail-inbox-view');
        }

        const bootscreen = document.getElementById('bootscreen');
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                bootscreen.style.opacity = '0';
                setTimeout(() => {
                    bootscreen.style.display = 'none';
                }, 1000);
            }, 2000);
        });

        updateDateTime();
        setInterval(updateDateTime, 60000);
    </script>
</body>
</html>
